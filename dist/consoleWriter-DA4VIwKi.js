var Fe=Object.defineProperty;var a=(t,e)=>Fe(t,"name",{value:e,configurable:!0});import Ue from"@anthropic-ai/sdk";import*as I from"zod";import L from"zod";import{FinishReason as P,GoogleGenAI as De,Type as oe}from"@google/genai";import He from"openai";import{serializeError as We}from"serialize-error";import{readFile as Be,access as qe,constants as Je}from"fs/promises";import{glob as ie}from"glob";import{readFile as F,access as ae,stat as Xe,writeFile as Ke,mkdir as je}from"node:fs/promises";import{resolve as Q,extname as ce,dirname as ze}from"node:path";import E from"chalk";import ue from"node:readline";class v extends Error{static{a(this,"AxleError")}code;id;details;constructor(e,n){super(e,{cause:n?.cause}),this.name=this.constructor.name,this.code=n?.code||"AXLE_ERROR",this.id=n?.id,this.details=n?.details,Object.setPrototypeOf(this,v.prototype)}}const O={CLAUDE_OPUS_4_20250514:"claude-opus-4-20250514",CLAUDE_OPUS_4_LATEST:"claude-opus-4-0",CLAUDE_SONNET_4_20250514:"claude-sonnet-4-20250514",CLAUDE_SONNET_4_LATEST:"claude-sonnet-4-0",CLAUDE_3_7_SONNET_20250219:"claude-3-7-sonnet-20250219",CLAUDE_3_7_SONNET_LATEST:"claude-3-7-sonnet-latest",CLAUDE_3_5_HAIKU_20241022:"claude-3-5-haiku-20241022",CLAUDE_3_5_HAIKU_LATEST:"claude-3-5-haiku-latest"},le=[O.CLAUDE_3_7_SONNET_LATEST,O.CLAUDE_3_7_SONNET_20250219,O.CLAUDE_3_5_HAIKU_LATEST,O.CLAUDE_3_5_HAIKU_20241022,O.CLAUDE_SONNET_4_LATEST,O.CLAUDE_SONNET_4_20250514,O.CLAUDE_OPUS_4_LATEST,O.CLAUDE_OPUS_4_20250514];var w=(t=>(t[t.Stop=0]="Stop",t[t.Length=1]="Length",t[t.FunctionCall=2]="FunctionCall",t[t.Error=3]="Error",t))(w||{});class Ze{static{a(this,"Chat")}system;messages=[];tools=[];setToolSchemas(e){this.tools=e}addSystem(e){this.system=e}addUser(e,n,s){let r,o=[];if(typeof n=="string"?(r=n,o=s||[]):Array.isArray(n)&&(o=n),!r&&o.length===0){this.messages.push({role:"user",content:e});return}const i=[{type:"text",text:e}];r&&i.push({type:"instructions",instructions:r});for(const c of o)i.push({type:"file",file:c});this.messages.push({role:"user",content:i})}addAssistant(e,n,s){this.messages.push({id:s.id??crypto.randomUUID(),role:"assistant",content:[{type:"text",text:e}],model:s.model,finishReason:s.finishReason,...n&&{toolCalls:n}})}addTools(e){this.messages.push({role:"tool",content:e})}hasFiles(){return this.messages.some(e=>Array.isArray(e.content)&&e.content.some(n=>n.type==="file"))}latest(){return this.messages[this.messages.length-1]}toString(){return JSON.stringify({system:this.system,messages:this.messages,tools:this.tools})}}function Ye(t,e=`

`){if(typeof t=="string")return t;const n=t.filter(r=>r.type==="text").map(r=>r.text),s=t.filter(r=>r.type==="instructions").map(r=>r.instructions);return n.length===0&&s.length===0?null:[...n,...s].join(e)}a(Ye,"getTextAndInstructions");function Qe(t){return typeof t=="string"?t:t.filter(e=>e.type==="text").map(e=>e.text).join(`

`)}a(Qe,"getTextContent");function Ve(t){if(typeof t=="string")return null;const e=t.filter(n=>n.type==="instructions").map(n=>n.instructions);return e.length>0?e.join(`

`):null}a(Ve,"getInstructions");function et(t){return typeof t=="string"?[]:t.filter(e=>e.type==="file"&&e.file.type==="document").map(e=>e.file)}a(et,"getDocuments");function tt(t){return typeof t=="string"?[]:t.filter(e=>e.type==="file"&&e.file.type==="image").map(e=>e.file)}a(tt,"getImages");function nt(t){const e=fe(t.messages),n=t.tools.map(s=>({name:s.name,description:s.description,input_schema:s.parameters}));return{system:t.system,messages:e,tools:n}}a(nt,"prepareRequest$4");function fe(t){return t.map(e=>{if(e.role==="assistant"){const n=[];return n.push(...rt(e.content)),e.toolCalls&&n.push(...e.toolCalls.map(s=>({type:"tool_use",id:s.id,name:s.name,input:s.arguments}))),{role:"assistant",content:n}}if(e.role==="tool")return{role:"user",content:e.content.map(n=>({type:"tool_result",tool_use_id:n.id,content:n.content}))};if(typeof e.content=="string")return{role:"user",content:e.content};{const n=[],s=Ye(e.content);s&&n.push({type:"text",text:s});const r=tt(e.content);r.length>0&&n.push(...r.map(i=>({type:"image",source:{type:"base64",media_type:i.mimeType,data:i.base64}})));const o=et(e.content);return o.length>0&&n.push(...o.filter(i=>i.mimeType==="application/pdf").map(i=>({type:"document",source:{type:"base64",media_type:"application/pdf",data:i.base64}}))),{role:"user",content:n}}})}a(fe,"convertToProviderMessages");function st(t){return t.map(e=>{const n=L.toJSONSchema(e.schema);if(!it(n))throw new Error(`Schema for tool ${e.name} must be an object type`);return{name:e.name,description:e.description,input_schema:n}})}a(st,"convertToProviderTools");function pe(t){const e=[];for(const n of t)n.type==="text"?e.push({type:"text",text:n.text}):n.type==="thinking"?e.push({type:"thinking",text:n.text||"",redacted:!1}):n.type==="redacted_thinking"&&e.push({type:"thinking",text:n.text||"",redacted:!0});return e}a(pe,"convertToAxleContentParts");function rt(t){const e=[];for(const n of t)n.type==="text"?e.push({type:"text",text:n.text}):n.type==="thinking"&&(n.redacted?e.push({type:"redacted_thinking",data:n.text}):e.push({type:"thinking",thinking:n.text,signature:n.signature}));return e}a(rt,"converToProviderContentParts");function ot(t){return t.slice(1).map(e=>{if(e.type==="tool_use")return{type:"tool-call",id:e.id,name:e.name,arguments:e.input}}).filter(e=>e)}a(ot,"convertToAxleToolCalls");function _e(t){switch(t){case"max_tokens":return w.Length;case"end_turn":return w.Stop;case"stop_sequence":return w.Stop;case"tool_use":return w.FunctionCall;case"pause_turn":case"refusal":default:return w.Error}}a(_e,"convertStopReason$1");function it(t){return t&&typeof t=="object"&&t.type==="object"}a(it,"isObjectSchema");const at=O.CLAUDE_SONNET_4_LATEST;class ct{static{a(this,"AnthropicProvider")}name="Anthropic";client;model;constructor(e,n){this.model=n??at,this.client=new Ue({apiKey:e})}createChatRequest(e,n={}){const{recorder:s}=n;return e.hasFiles()&&!le.includes(this.model)&&s?.warn?.log(`Model ${this.model} may not support multimodal content. Use one of: ${le.join(", ")}`),new lt(this,e)}async createGenerationRequest(e){return await ut({client:this.client,model:this.model,...e})}}async function ut(t){const{client:e,model:n,messages:s,tools:r,context:o}=t,{recorder:i}=o,c={model:n,max_tokens:4096,messages:fe(s),...r&&{tools:st(r)}};i?.debug?.log(c);let l;try{const u=await e.messages.create(c);l=de(u)}catch(u){l={type:"error",error:{type:u.error.error.type??"Undetermined",message:u.error.error.message??"Unexpected error from Anthropic"},usage:{in:0,out:0},raw:u}}return i?.debug?.log(l),l}a(ut,"createGenerationRequest$2");class lt{static{a(this,"AnthropicChatRequest")}constructor(e,n){this.provider=e,this.chat=n}async execute(e){const{recorder:n}=e,{client:s,model:r}=this.provider,o={model:r,max_tokens:4096,...nt(this.chat)};n?.debug?.log(o);let i;try{const c=await s.messages.create(o);i=de(c)}catch(c){i={type:"error",error:{type:c.error.error.type??"Undetermined",message:c.error.error.message??"Unexpected error from Anthropic"},usage:{in:0,out:0},raw:c}}return n?.debug?.log(i),i}}function de(t){const e=_e(t.stop_reason);if(e===w.Error)return{type:"error",error:{type:"Uncaught error",message:`Stop reason is not recognized or unhandled: ${t.stop_reason}`},usage:{in:t.usage.input_tokens,out:t.usage.output_tokens},raw:t};if(e===w.FunctionCall)return{type:"success",id:t.id,model:t.model,reason:w.FunctionCall,message:{id:t.id,role:t.role,content:pe(t.content),toolCalls:ot(t.content)},usage:{in:t.usage.input_tokens,out:t.usage.output_tokens},raw:t};if(t.type=="message")return{type:"success",id:t.id,model:t.model,reason:e,message:{role:"assistant",id:t.id,model:t.model,content:pe(t.content)},usage:{in:t.usage.input_tokens,out:t.usage.output_tokens},raw:t}}a(de,"convertToAIResponse");const _={GEMINI_1_0_PRO_VISION_LATEST:"gemini-1.0-pro-vision-latest",GEMINI_PRO_VISION:"gemini-pro-vision",GEMINI_1_5_PRO_LATEST:"gemini-1.5-pro-latest",GEMINI_1_5_PRO_001:"gemini-1.5-pro-001",GEMINI_1_5_PRO_002:"gemini-1.5-pro-002",GEMINI_1_5_PRO:"gemini-1.5-pro",GEMINI_1_5_FLASH_LATEST:"gemini-1.5-flash-latest",GEMINI_1_5_FLASH_001:"gemini-1.5-flash-001",GEMINI_1_5_FLASH_001_TUNING:"gemini-1.5-flash-001-tuning",GEMINI_1_5_FLASH:"gemini-1.5-flash",GEMINI_1_5_FLASH_002:"gemini-1.5-flash-002",GEMINI_1_5_FLASH_8B:"gemini-1.5-flash-8b",GEMINI_1_5_FLASH_8B_001:"gemini-1.5-flash-8b-001",GEMINI_1_5_FLASH_8B_LATEST:"gemini-1.5-flash-8b-latest",GEMINI_1_5_FLASH_8B_EXP_0827:"gemini-1.5-flash-8b-exp-0827",GEMINI_1_5_FLASH_8B_EXP_0924:"gemini-1.5-flash-8b-exp-0924",GEMINI_2_5_PRO_EXP_03_25:"gemini-2.5-pro-exp-03-25",GEMINI_2_5_PRO_PREVIEW_03_25:"gemini-2.5-pro-preview-03-25",GEMINI_2_5_FLASH_PREVIEW_04_17:"gemini-2.5-flash-preview-04-17",GEMINI_2_5_FLASH_PREVIEW_05_20:"gemini-2.5-flash-preview-05-20",GEMINI_2_5_FLASH_PREVIEW_04_17_THINKING:"gemini-2.5-flash-preview-04-17-thinking",GEMINI_2_5_PRO_PREVIEW_05_06:"gemini-2.5-pro-preview-05-06",GEMINI_2_5_PRO_PREVIEW_06_05:"gemini-2.5-pro-preview-06-05",GEMINI_2_0_FLASH_EXP:"gemini-2.0-flash-exp",GEMINI_2_0_FLASH:"gemini-2.0-flash",GEMINI_2_0_FLASH_001:"gemini-2.0-flash-001",GEMINI_2_0_FLASH_EXP_IMAGE_GENERATION:"gemini-2.0-flash-exp-image-generation",GEMINI_2_0_FLASH_LITE_001:"gemini-2.0-flash-lite-001",GEMINI_2_0_FLASH_LITE:"gemini-2.0-flash-lite",GEMINI_2_0_FLASH_PREVIEW_IMAGE_GENERATION:"gemini-2.0-flash-preview-image-generation",GEMINI_2_0_FLASH_LITE_PREVIEW_02_05:"gemini-2.0-flash-lite-preview-02-05",GEMINI_2_0_FLASH_LITE_PREVIEW:"gemini-2.0-flash-lite-preview",GEMINI_2_0_PRO_EXP:"gemini-2.0-pro-exp",GEMINI_2_0_PRO_EXP_02_05:"gemini-2.0-pro-exp-02-05",GEMINI_EXP_1206:"gemini-exp-1206",GEMINI_2_0_FLASH_THINKING_EXP_01_21:"gemini-2.0-flash-thinking-exp-01-21",GEMINI_2_0_FLASH_THINKING_EXP:"gemini-2.0-flash-thinking-exp",GEMINI_2_0_FLASH_THINKING_EXP_1219:"gemini-2.0-flash-thinking-exp-1219",GEMINI_2_5_FLASH_PREVIEW_TTS:"gemini-2.5-flash-preview-tts",GEMINI_2_5_PRO_PREVIEW_TTS:"gemini-2.5-pro-preview-tts",LEARNLM_2_0_FLASH_EXPERIMENTAL:"learnlm-2.0-flash-experimental",GEMMA_3_1B_IT:"gemma-3-1b-it",GEMMA_3_4B_IT:"gemma-3-4b-it",GEMMA_3_12B_IT:"gemma-3-12b-it",GEMMA_3_27B_IT:"gemma-3-27b-it",GEMMA_3N_E4B_IT:"gemma-3n-e4b-it"},ge=[_.GEMINI_1_0_PRO_VISION_LATEST,_.GEMINI_PRO_VISION,_.GEMINI_1_5_PRO_LATEST,_.GEMINI_1_5_PRO_001,_.GEMINI_1_5_PRO_002,_.GEMINI_1_5_PRO,_.GEMINI_1_5_FLASH_LATEST,_.GEMINI_1_5_FLASH_001,_.GEMINI_1_5_FLASH_001_TUNING,_.GEMINI_1_5_FLASH,_.GEMINI_1_5_FLASH_002,_.GEMINI_1_5_FLASH_8B,_.GEMINI_1_5_FLASH_8B_001,_.GEMINI_1_5_FLASH_8B_LATEST,_.GEMINI_1_5_FLASH_8B_EXP_0827,_.GEMINI_1_5_FLASH_8B_EXP_0924,_.GEMINI_2_5_PRO_EXP_03_25,_.GEMINI_2_5_PRO_PREVIEW_03_25,_.GEMINI_2_5_FLASH_PREVIEW_04_17,_.GEMINI_2_5_FLASH_PREVIEW_05_20,_.GEMINI_2_5_FLASH_PREVIEW_04_17_THINKING,_.GEMINI_2_5_PRO_PREVIEW_05_06,_.GEMINI_2_5_PRO_PREVIEW_06_05,_.GEMINI_2_0_FLASH_EXP,_.GEMINI_2_0_FLASH,_.GEMINI_2_0_FLASH_001,_.GEMINI_2_0_FLASH_EXP_IMAGE_GENERATION,_.GEMINI_2_0_FLASH_LITE_001,_.GEMINI_2_0_FLASH_LITE,_.GEMINI_2_0_FLASH_PREVIEW_IMAGE_GENERATION,_.GEMINI_2_0_FLASH_LITE_PREVIEW_02_05,_.GEMINI_2_0_FLASH_LITE_PREVIEW,_.GEMINI_2_0_PRO_EXP,_.GEMINI_2_0_PRO_EXP_02_05,_.GEMINI_EXP_1206,_.GEMINI_2_0_FLASH_THINKING_EXP_01_21,_.GEMINI_2_0_FLASH_THINKING_EXP,_.GEMINI_2_0_FLASH_THINKING_EXP_1219,_.GEMINI_2_5_FLASH_PREVIEW_TTS,_.GEMINI_2_5_PRO_PREVIEW_TTS,_.LEARNLM_2_0_FLASH_EXPERIMENTAL,_.GEMMA_3_1B_IT,_.GEMMA_3_4B_IT,_.GEMMA_3_12B_IT,_.GEMMA_3_27B_IT,_.GEMMA_3N_E4B_IT];function me(t){return t.map(ft).filter(e=>e!==void 0)}a(me,"convertAxleMessagesToGoogleAI");function ft(t){switch(t.role){case"tool":return pt(t);case"assistant":return _t(t);case"user":return dt(t)}}a(ft,"convertMessage$3");function pt(t){return{role:"user",parts:t.content.map(e=>({functionResponse:{id:e.id??void 0,name:e.name,response:{output:e.content}}}))}}a(pt,"convertToolMessage$3");function _t(t){const e=[];if(t.content!==void 0&&t.content.length>0){const n=t.content.map(s=>s.text).join("");n&&e.push({text:n})}return t.toolCalls&&e.push(...t.toolCalls.map(n=>{let s;return typeof n.arguments=="string"?s=JSON.parse(n.arguments):s=n.arguments,{functionCall:{id:n.id??void 0,name:n.name,args:s}}})),{role:"assistant",parts:e}}a(_t,"convertAssistantMessage$3");function dt(t){return typeof t.content=="string"?{role:"user",parts:[{text:t.content}]}:{role:"user",parts:t.content.map(gt).filter(n=>n!==null)}}a(dt,"convertUserMessage$3");function gt(t){return t.type==="text"||t.type==="instructions"?{text:t.type==="text"?t.text:t.instructions}:t.type==="file"&&(t.file.type==="image"||t.file.type==="document")?{inlineData:{mimeType:t.file.mimeType,data:t.file.base64}}:null}a(gt,"convertContentPart$3");function mt(t){switch(t){case P.STOP:return[!0,w.Stop];case P.MAX_TOKENS:return[!0,w.Length];case P.FINISH_REASON_UNSPECIFIED:case P.SAFETY:case P.RECITATION:case P.LANGUAGE:case P.OTHER:case P.BLOCKLIST:case P.PROHIBITED_CONTENT:case P.SPII:case P.MALFORMED_FUNCTION_CALL:case P.IMAGE_SAFETY:return[!1,w.Error]}}a(mt,"convertStopReason");const ht=_.GEMINI_2_5_FLASH_PREVIEW_05_20;class yt{static{a(this,"GoogleAIProvider")}name="GoogleAI";client;model;constructor(e,n){this.model=n??ht,this.client=new De({apiKey:e})}createChatRequest(e,n={}){const{recorder:s}=n;return e.hasFiles()&&!ge.includes(this.model)&&s?.warn.log(`Model ${this.model} does not support multimodal content. Use one of: ${ge.join(", ")}`),new Et(this,e)}async createGenerationRequest(e){return await It({client:this.client,model:this.model,...e})}}async function It(t){const{client:e,model:n,messages:s,tools:r,context:o}=t,{recorder:i}=o,c=me(s),l={};r&&r.length>0&&(l.tools=r.map(p=>{const g=L.toJSONSchema(p.schema);return{functionDeclarations:[{name:p.name,description:p.description,parameters:{...g,type:oe.OBJECT}}]}}));const u={contents:c,config:l};i?.debug?.log(u);let f;try{const p=await e.models.generateContent({model:n,...u});f=he(p,{recorder:i})}catch(p){i?.error?.log(p),f={type:"error",error:{type:p.name??"Undetermined",message:p.message??"Unexpected error from Google AI"},usage:{in:0,out:0},raw:p}}return i?.debug?.log(f),f}a(It,"createGenerationRequest$1");class Et{static{a(this,"GoogleAIChatRequest")}constructor(e,n){this.provider=e,this.chat=n}async execute(e){const{recorder:n}=e,{client:s,model:r}=this.provider,o=wt(this.chat);n?.debug?.log(o);let i;try{const c=await s.models.generateContent({model:r,...o});i=he(c,e)}catch(c){n?.error?.log(c),i={type:"error",error:{type:c.name??"Undetermined",message:c.message??"Unexpected error from Google AI"},usage:{in:0,out:0},raw:c}}return n?.debug?.log(i),i}}function wt(t){const e=Tt(t),n=vt(t);return{contents:e,config:n}}a(wt,"prepareRequest$3");function Tt(t){return t.messages.length===1&&t.messages[0].role=="user"&&typeof t.messages[0].content=="string"?t.messages[0].content:me(t.messages)}a(Tt,"prepareContents");function vt(t){const e={};return t.system&&(e.systemInstruction=t.system),t.tools.length>0&&(e.tools=t.tools.map(n=>({functionDeclarations:[{name:n.name,description:n.description,parameters:{...n.parameters,type:oe.OBJECT}}]}))),e}a(vt,"prepareConfig");function he(t,e){const{recorder:n}=e,s=t.usageMetadata.promptTokenCount,r=t.usageMetadata.totalTokenCount-s,o={in:s,out:r};if(!t)return{type:"error",error:{type:"InvalidResponse",message:"Invalid or empty response from Google AI"},usage:{in:0,out:0},raw:t};if(t.promptFeedback&&t.promptFeedback.blockReason)return{type:"error",error:{type:"Blocked",message:`Response blocked by Google AI: ${t.promptFeedback.blockReason}, ${t.promptFeedback.blockReasonMessage}`},usage:o,raw:t};if(!t.candidates||t.candidates.length===0)return{type:"error",error:{type:"InvalidResponse",message:"Invalid or empty response from Google AI"},usage:{in:0,out:0},raw:t};t.candidates.length>1&&n?.warn?.log(`We received ${t.candidates.length} response candidates`);const i=t.candidates[0],l=(i.content?.parts||[]).map(p=>p.text).filter(p=>p!==void 0).join(""),[u,f]=mt(i.finishReason);if(u){let p;return t.functionCalls&&(p=t.functionCalls.map(g=>({type:"tool-call",id:g.id,name:g.name,arguments:JSON.stringify(g.args)}))),{type:"success",id:t.responseId,model:t.modelVersion,reason:t.functionCalls?w.FunctionCall:f,message:{id:t.responseId,role:"assistant",content:[{type:"text",text:l}],...p?{toolCalls:p}:{}},usage:o,raw:t}}else return{type:"error",error:{type:"Undetermined",message:`Unexpected stop reason: ${f}`},usage:o,raw:t}}a(he,"translateResponse$2");function ye(t){return t.map(At).flat(1)}a(ye,"convertAxleMessagesToOllama");function Pt(t){return t&&t.length>0?t.map(e=>({type:"function",function:{name:e.name,description:e.description,parameters:L.toJSONSchema(e.schema)}})):void 0}a(Pt,"convertToolDefToOllama");function At(t){switch(t.role){case"tool":return St(t);case"assistant":return Rt(t);default:return Nt(t)}}a(At,"convertMessage$2");function St(t){return t.content.map(e=>({role:"tool",tool_call_id:e.id,content:e.content}))}a(St,"convertToolMessage$2");function Rt(t){const e=t.toolCalls?.map(n=>{const s=n.id;return{type:"function",function:{name:n.name,arguments:n.arguments},...s&&{id:s}}});return{role:t.role,content:t.content.map(n=>n.text).join(""),...e&&{toolCalls:e}}}a(Rt,"convertAssistantMessage$2");function Nt(t){if(typeof t.content=="string")return{role:t.role,content:t.content};{const e=[],n=[];for(const s of t.content){const r=Ot(s);r.text!==null&&e.push(r.text),r.image!==null&&n.push(r.image)}return{role:t.role,content:e.join(""),...n.length>0&&{images:n}}}}a(Nt,"convertUserMessage$2");function Ot(t){return t.type==="text"||t.type==="instructions"?{text:t.type==="text"?t.text:t.instructions,image:null}:t.type==="file"&&t.file.type==="image"?{text:null,image:t.file.base64}:{text:null,image:null}}a(Ot,"convertContentPart$2");const bt="http://localhost:11434";class xt{static{a(this,"OllamaProvider")}name="Ollama";url;model;recorder;constructor(e,n){this.url=n||bt,this.model=e}createChatRequest(e,n={}){const{recorder:s}=n;return e.hasFiles()&&s?.warn?.log(`Ollama model ${this.model} multimodal support depends on the specific model. Ensure you're using a vision-capable model like llava.`),new Mt(this.url,this.model,e)}async createGenerationRequest(e){return await kt({url:this.url,model:this.model,...e})}}async function kt(t){const{url:e,model:n,messages:s,tools:r,context:o}=t,{recorder:i}=o,c=Pt(r),l={model:n,messages:ye(s),stream:!1,options:{temperature:.7},...c&&{tools:c}};i?.debug?.log(l);let u;try{const f=await fetch(`${e}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!f.ok)throw new Error(`HTTP error! status: ${f.status}`);const p=await f.json();u=Ie(p)}catch(f){i?.error?.log("Error fetching Ollama response:",f),u={type:"error",error:{type:"OllamaError",message:f.message||"Unexpected error from Ollama"},usage:{in:0,out:0},raw:JSON.stringify(f)}}return i?.debug?.log(u),u}a(kt,"createGenerationRequest");class Mt{static{a(this,"OllamaChatCompletionRequest")}chat;url;model;constructor(e,n,s){this.url=e,this.model=n,this.chat=s}async execute(e){const{recorder:n}=e,s={stream:!1,options:{temperature:.7},...$t(this.chat,this.model)};n?.debug?.log(s);let r;try{const o=await fetch(`${this.url}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!o.ok)throw console.log(o),new Error(`HTTP error! status: ${o.status}`);const i=await o.json();r=Ie(i)}catch(o){n?.error?.log("Error fetching Ollama response:",o),r={type:"error",error:{type:"OllamaError",message:o.message||"Unexpected error from Ollama"},usage:{in:0,out:0},raw:JSON.stringify(o)}}return n?.debug?.log(r),r}}function $t(t,e){const n=Gt(t),s=Ct(t),r=ye(t.messages);return{model:e,messages:[...n,...r],...s&&{tools:s}}}a($t,"prepareRequest$2");function Gt(t){return t.system?[{role:"system",content:t.system}]:[]}a(Gt,"prepareSystemMessage");function Ct(t){if(t.tools.length!==0)return t.tools.map(e=>({type:"function",function:e}))}a(Ct,"prepareTools");function Ie(t){if(t.done_reason==="stop"&&t.message){const e=t.message.content,n=[];if(t.message.tool_calls)for(const r of t.message.tool_calls)n.push({type:"tool-call",id:r.id,name:r.function.name,arguments:r.function.arguments});const s=n.length>0;return{type:"success",id:`ollama-${Date.now()}`,model:t.model,reason:s?w.FunctionCall:w.Stop,message:{id:`ollama-${Date.now()}`,role:"assistant",content:[{type:"text",text:e}],...s&&{toolCalls:n}},usage:{in:t.prompt_eval_count||0,out:t.eval_count||0},raw:t}}return{type:"error",error:{type:"OllamaError",message:"Unexpected error from Ollama"},usage:{in:0,out:0},raw:t}}a(Ie,"translateResponse$1");const d={GPT_4_1:"gpt-4.1",GPT_4_1_2025_04_14:"gpt-4.1-2025-04-14",GPT_4_1_MINI:"gpt-4.1-mini",GPT_4_1_MINI_2025_04_14:"gpt-4.1-mini-2025-04-14",GPT_4_1_NANO:"gpt-4.1-nano",GPT_4_1_NANO_2025_04_14:"gpt-4.1-nano-2025-04-14",GPT_4O:"gpt-4o",GPT_4O_2024_05_13:"gpt-4o-2024-05-13",GPT_4O_2024_08_06:"gpt-4o-2024-08-06",GPT_4O_2024_11_20:"gpt-4o-2024-11-20",GPT_4O_AUDIO_PREVIEW:"gpt-4o-audio-preview",GPT_4O_AUDIO_PREVIEW_2024_10_01:"gpt-4o-audio-preview-2024-10-01",GPT_4O_AUDIO_PREVIEW_2024_12_17:"gpt-4o-audio-preview-2024-12-17",GPT_4O_AUDIO_PREVIEW_2025_06_03:"gpt-4o-audio-preview-2025-06-03",GPT_4O_MINI:"gpt-4o-mini",GPT_4O_MINI_2024_07_18:"gpt-4o-mini-2024-07-18",GPT_4O_MINI_AUDIO_PREVIEW:"gpt-4o-mini-audio-preview",GPT_4O_MINI_AUDIO_PREVIEW_2024_12_17:"gpt-4o-mini-audio-preview-2024-12-17",GPT_4O_MINI_REALTIME_PREVIEW:"gpt-4o-mini-realtime-preview",GPT_4O_MINI_REALTIME_PREVIEW_2024_12_17:"gpt-4o-mini-realtime-preview-2024-12-17",GPT_4O_MINI_SEARCH_PREVIEW:"gpt-4o-mini-search-preview",GPT_4O_MINI_SEARCH_PREVIEW_2025_03_11:"gpt-4o-mini-search-preview-2025-03-11",GPT_4O_MINI_TRANSCRIBE:"gpt-4o-mini-transcribe",GPT_4O_MINI_TTS:"gpt-4o-mini-tts",GPT_4O_REALTIME_PREVIEW:"gpt-4o-realtime-preview",GPT_4O_REALTIME_PREVIEW_2024_10_01:"gpt-4o-realtime-preview-2024-10-01",GPT_4O_REALTIME_PREVIEW_2024_12_17:"gpt-4o-realtime-preview-2024-12-17",GPT_4O_REALTIME_PREVIEW_2025_06_03:"gpt-4o-realtime-preview-2025-06-03",GPT_4O_SEARCH_PREVIEW:"gpt-4o-search-preview",GPT_4O_SEARCH_PREVIEW_2025_03_11:"gpt-4o-search-preview-2025-03-11",GPT_4O_TRANSCRIBE:"gpt-4o-transcribe",O3_MINI:"o3-mini",O3_MINI_2025_01_31:"o3-mini-2025-01-31",O4_MINI:"o4-mini",O4_MINI_2025_04_16:"o4-mini-2025-04-16"},Ee=[d.GPT_4_1,d.GPT_4_1_2025_04_14,d.GPT_4_1_MINI,d.GPT_4_1_MINI_2025_04_14,d.GPT_4_1_NANO,d.GPT_4_1_NANO_2025_04_14,d.GPT_4O,d.GPT_4O_2024_05_13,d.GPT_4O_2024_08_06,d.GPT_4O_2024_11_20,d.GPT_4O_AUDIO_PREVIEW,d.GPT_4O_AUDIO_PREVIEW_2024_10_01,d.GPT_4O_AUDIO_PREVIEW_2024_12_17,d.GPT_4O_AUDIO_PREVIEW_2025_06_03,d.GPT_4O_MINI,d.GPT_4O_MINI_2024_07_18,d.GPT_4O_MINI_AUDIO_PREVIEW,d.GPT_4O_MINI_AUDIO_PREVIEW_2024_12_17,d.GPT_4O_MINI_REALTIME_PREVIEW,d.GPT_4O_MINI_REALTIME_PREVIEW_2024_12_17,d.GPT_4O_MINI_SEARCH_PREVIEW,d.GPT_4O_MINI_SEARCH_PREVIEW_2025_03_11,d.GPT_4O_MINI_TRANSCRIBE,d.GPT_4O_MINI_TTS,d.GPT_4O_REALTIME_PREVIEW,d.GPT_4O_REALTIME_PREVIEW_2024_10_01,d.GPT_4O_REALTIME_PREVIEW_2024_12_17,d.GPT_4O_REALTIME_PREVIEW_2025_06_03,d.GPT_4O_SEARCH_PREVIEW,d.GPT_4O_SEARCH_PREVIEW_2025_03_11,d.GPT_4O_TRANSCRIBE,d.O3_MINI,d.O3_MINI_2025_01_31,d.O4_MINI,d.O4_MINI_2025_04_16];function we(t){return t.map(Lt).flat(1)}a(we,"convertAxleMessagesToChatCompletion");function Lt(t){switch(t.role){case"tool":return Ft(t);case"assistant":return Ut(t);default:return Dt(t)}}a(Lt,"convertMessage$1");function Ft(t){return t.content.map(e=>({role:"tool",tool_call_id:e.id,content:e.content}))}a(Ft,"convertToolMessage$1");function Ut(t){const e=t.toolCalls?.map(n=>{const s=n.id;return{type:"function",function:{name:n.name,arguments:typeof n.arguments=="string"?n.arguments:JSON.stringify(n.arguments)},...s&&{id:s}}});return{role:t.role,content:t.content.map(n=>n.text).join(""),...e&&{toolCalls:e}}}a(Ut,"convertAssistantMessage$1");function Dt(t){if(typeof t.content=="string")return{role:t.role,content:t.content};{const e=t.content.map(Ht).filter(n=>n!==null);return{role:t.role,content:e}}}a(Dt,"convertUserMessage$1");function Ht(t){if(t.type==="text"||t.type==="instructions")return{type:"text",text:t.type==="text"?t.text:t.instructions};if(t.type==="file"){if(t.file.type==="image")return{type:"image_url",image_url:{url:`data:${t.file.mimeType};base64,${t.file.base64}`}};if(t.file.type==="document")return{type:"file",file:{filename:t.file.name,file_data:`data:${t.file.mimeType};base64,${t.file.base64}`}}}return null}a(Ht,"convertContentPart$1");class Wt{static{a(this,"OpenAIChatCompletionRequest")}constructor(e,n){this.provider=e,this.chat=n}async execute(e){const{recorder:n}=e,{client:s,model:r}=this.provider,o=Bt(this.chat,r);n?.debug?.heading.log("[Open AI Provider] Using the ChatCompletion API"),n?.debug?.log(o);let i;try{const c=await s.chat.completions.create(o);i=Te(c)}catch(c){n?.error?.log(c),i={type:"error",error:{type:c.type??"Undetermined",message:c.message??"Unexpected error from OpenAI"},usage:{in:0,out:0},raw:c}}return n?.debug?.log(i),i}}function Bt(t,e){const n=[];t.system&&n.push({role:"system",content:t.system});let s;return t.tools.length>0&&(s=t.tools.map(r=>({type:"function",function:r}))),{model:e,messages:[...n,...we(t.messages)],...s&&{tools:s}}}a(Bt,"prepareRequest$1");function Te(t){if(t.choices.length>0){const e=t.choices[0],n=e.message.tool_calls?.filter(s=>s.type==="function")?.map(s=>({type:"tool-call",id:s.id,name:s.function.name,arguments:s.function.arguments}));return{type:"success",id:t.id,model:t.model,reason:_e(e.finish_reason),message:{id:t.id,content:[{type:"text",text:e.message.content??""}],role:e.message.role,toolCalls:n},usage:{in:t.usage?.prompt_tokens??0,out:t.usage?.completion_tokens??0},raw:t}}return{type:"error",error:{type:"undetermined",message:"Unexpected response from OpenAI"},usage:{in:t.usage?.prompt_tokens??0,out:t.usage?.completion_tokens??0},raw:t}}a(Te,"translateResponse");function ve(t){return t.map(qt).flat(1)}a(ve,"convertAxleMessageToResponseInput");function qt(t){switch(t.role){case"tool":return Jt(t);case"assistant":return Xt(t);default:return Kt(t)}}a(qt,"convertMessage");function Jt(t){return t.content.map(e=>({type:"function_call_output",call_id:e.id,output:e.content}))}a(Jt,"convertToolMessage");function Xt(t){const e=t.toolCalls?.map(n=>{const s=n.id;return{type:"function",function:{name:n.name,arguments:typeof n.arguments=="string"?n.arguments:JSON.stringify(n.arguments)},...s&&{id:s}}});return{role:t.role,content:Qe(t.content),...e&&{toolCalls:e}}}a(Xt,"convertAssistantMessage");function Kt(t){if(typeof t.content=="string")return{role:t.role,content:t.content};{const e=t.content.map(jt).filter(n=>n!==null);return{role:t.role,content:e}}}a(Kt,"convertUserMessage");function jt(t){if(t.type==="text")return{type:"input_text",text:t.text};if(t.type==="file"){if(t.file.type==="image")return{type:"input_image",image_url:`data:${t.file.mimeType};base64,${t.file.base64}`,detail:"auto"};if(t.file.type==="document")return{type:"input_file",filename:t.file.path,file_data:`data:${t.file.mimeType};base64,${t.file.base64}`}}return null}a(jt,"convertContentPart");class zt{static{a(this,"OpenAIResponsesAPI")}constructor(e,n){this.provider=e,this.chat=n}async execute(e){const{recorder:n}=e,{client:s,model:r}=this.provider,o=Zt(this.chat,r);n?.debug?.heading.log("[Open AI Provider] Using the Responses API"),n?.debug?.log(o);let i;try{const c=await s.responses.create(o);i=Pe(c)}catch(c){n?.error?.log(c),i={type:"error",error:{type:c.type??"Undetermined",message:c.message??"Unexpected error from OpenAI"},usage:{in:0,out:0},raw:c}}return n?.debug?.log(i),i}}function Zt(t,e){const n={model:e,input:ve(t.messages)},s=t.latest();if(s&&s.role==="user"){let r="";const o=Ve(s.content);t.system&&(r=t.system),o&&(r=r?`${r}

${o}`:o),r&&(n.instructions=r)}return t.tools.length>0&&(n.tools=t.tools.map(r=>({type:"function",strict:!0,...r}))),n}a(Zt,"prepareRequest");function Pe(t){if(t.error)return{type:"error",error:{type:t.error.code||"undetermined",message:t.error.message||"Response generation failed"},usage:{in:t.usage?.input_tokens??0,out:t.usage?.output_tokens??0},raw:t};const e=t.output?.filter(n=>n.type==="function_call")?.map(n=>({type:"tool-call",id:n.id||"",name:n.name||"",arguments:n.arguments||""}));return{type:"success",id:t.id,model:t.model||"",reason:t.incomplete_details?w.Error:w.Stop,message:{id:t.id,content:[{type:"text",text:t.output_text||""}],role:"assistant",...e?.length&&{toolCalls:e}},usage:{in:t.usage?.input_tokens??0,out:t.usage?.output_tokens??0},raw:t}}a(Pe,"translateResponseToAIResponse");const Yt=d.GPT_4_1;class Qt{static{a(this,"OpenAIProvider")}name="OpenAI";client;model;constructor(e,n){this.model=n||Yt,this.client=new He({apiKey:e})}createChatRequest(e,n={}){const{recorder:s}=n;return Ee.includes(this.model)?new zt(this,e):new Wt(this,e)}async createGenerationRequest(e){return Ee.includes(this.model)?await Vt({client:this.client,model:this.model,...e}):await en({client:this.client,model:this.model,...e})}}async function Vt(t){const{client:e,model:n,messages:s,tools:r,context:o}=t,{recorder:i}=o,c={model:n,input:ve(s)};r&&r.length>0&&(c.tools=r.map(u=>{const f=L.toJSONSchema(u.schema);return{type:"function",strict:!0,name:u.name,description:u.description,parameters:f}})),i?.debug?.log(c);let l;try{const u=await e.responses.create(c);l=Pe(u)}catch(u){i?.error?.log(u),l={type:"error",error:{type:u.type??"Undetermined",message:u.message??"Unexpected error from OpenAI"},usage:{in:0,out:0},raw:u}}return i?.debug?.log(l),l}a(Vt,"createGenerationRequestWithResponsesAPI");async function en(t){const{client:e,model:n,messages:s,tools:r,context:o}=t,{recorder:i}=o;let c;r&&r.length>0&&(c=r.map(f=>{const p=L.toJSONSchema(f.schema);return{type:"function",function:{name:f.name,description:f.description,parameters:p}}}));const l={model:n,messages:we(s),...c&&{tools:c}};i?.debug?.log(l);let u;try{const f=await e.chat.completions.create(l);u=Te(f)}catch(f){i?.error?.log(f),u={type:"error",error:{type:f.type??"Undetermined",message:f.message??"Unexpected error from OpenAI"},usage:{in:0,out:0},raw:f}}return i?.debug?.log(u),u}a(en,"createGenerationRequestWithChatCompletion");function tn(t,e){if(!e||Object.keys(e).length===0)throw new v(`The provider ${t} is not configured. Please check your configuration.`);switch(t){case"openai":return new Qt(e["api-key"],e.model);case"anthropic":return new ct(e["api-key"],e.model);case"googleai":return new yt(e["api-key"],e.model);case"ollama":{const n=e;return new xt(n.model,n.url)}default:throw new v("The provider is unsupported")}}a(tn,"getProvider");class se extends v{static{a(this,"TaskError")}constructor(e,n){super(e,{code:"TASK_ERROR",id:n?.id,details:{taskType:n?.taskType,taskIndex:n?.taskIndex,...n?.details},cause:n?.cause}),Object.setPrototypeOf(this,se.prototype)}}const m={Running:"running",Success:"success",PartialSuccess:"partialSuccess",Fail:"fail"};var T=(t=>(t[t.Trace=10]="Trace",t[t.Debug=20]="Debug",t[t.Info=30]="Info",t[t.Warn=40]="Warn",t[t.Error=50]="Error",t[t.Fatal=60]="Fatal",t))(T||{});class nn{static{a(this,"Recorder")}instanceId=crypto.randomUUID();currentLevel=T.Info;logs=[];writers=[];_debug;_info;_warn;_error;constructor(){this.buildMethods()}buildMethods(){this._debug=T.Debug>=this.currentLevel?this.createLoggingFunction(T.Debug):null,this._info=T.Info>=this.currentLevel?this.createLoggingFunction(T.Info):null,this._warn=T.Warn>=this.currentLevel?this.createLoggingFunction(T.Warn):null,this._error=this.createLoggingFunction(T.Error)}set level(e){this.currentLevel=e,this.buildMethods()}get level(){return this.currentLevel}get info(){return this._info}get warn(){return this._warn}get error(){return this._error}get debug(){return this._debug}subscribe(e){this.writers.includes(e)||this.writers.push(e)}unsubscribe(e){const n=this.writers.indexOf(e);n!==-1&&this.writers.splice(n,1)}publish(e){this.logs.push(e);for(const n of this.writers)n.handleEvent(e)}logFunction(e,n,...s){let r=s.map(o=>typeof o=="string"?{message:o}:o instanceof Error?We(o):o);this.publish({level:e,time:Date.now(),kind:n,payload:r})}createLoggingFunction(e){return{log:this.logFunction.bind(this,e,"body"),heading:{log:this.logFunction.bind(this,e,"heading")}}}getLogs(e=T.Info){return this.logs.filter(n=>n.level>=e)}async shutdown(){for(const e of this.writers)typeof e.flush=="function"&&await e.flush()}}async function sn(t,e){const{defaults:n,tag:s}=e;let r=null,o="";if(t)try{o=Q(t),r=await F(o,{encoding:"utf-8"})}catch{throw new Error(`${s} not found, see --help for details`)}else{for(const i of n.formats)try{o=Q(n.name+"."+i),r=await F(o,{encoding:"utf-8"});break}catch{continue}if(r===null)throw new Error(`${s} not found, see --help for details`)}return{content:r,format:o.split(".").pop()??""}}a(sn,"searchAndLoadFile");async function rn(t,e){let n="";for(const s of t){const r=await ie(s);e?.debug?.log(`many-files parser. For glob "${s}", found ${r.length} files.`);const o=await Promise.all(r.map(async i=>{const c=await F(i,"utf-8");return i+`:
`+c}));n+=o.join(`
`)}return n}a(rn,"loadManyFiles");function on(t,e){t=t.replace("**/*","**");const n=/(?<asterisks>\*{1,2})(?<extension>\.[^\\/]+)?/,s=t.match(n);if(s){let r="";return s.groups?.asterisks.length==1?r+=e.stem:r+=e.dir+e.stem,s.groups?.extension?r+=s.groups.extension:r+=e.ext,t.replace(s[0],r)}return t}a(on,"replaceFilePattern");function an(t){const e=/(?<name>[^\\/]+)(?<extension>\.[^\\/]+)$/,n=t.match(e);return n&&n.length>0&&n.groups?{abs:t,dir:t.replace(n[0],""),ext:n.groups.extension,stem:n.groups.name,name:n[0]}:null}a(an,"pathToComponents");async function Ae(t){const e=ze(t);try{await ae(e)}catch{await je(e),await Ae(e)}}a(Ae,"ensureDirectoryExistence");async function cn({filePath:t,content:e}){await Ae(t),await Ke(t,e)}a(cn,"writeFileWithDirectories");const H=[".jpg",".jpeg",".png",".gif",".webp",".bmp",".tiff"],W=[".pdf"],B=[".txt",".md",".markdown"],Se=20*1024*1024;function un(t){return t.type==="text"}a(un,"isTextFileInfo");function ln(t){return t.type==="image"||t.type==="document"}a(ln,"isBase64FileInfo");function fn(t){const e=ce(t).toLowerCase();if(B.includes(e))return"utf-8";if(H.includes(e)||W.includes(e))return"base64";{const n=[...B,...H,...W];throw new Error(`Unsupported file type: ${e}. Supported types: ${n.join(", ")}`)}}a(fn,"getEncodingForFile");async function q(t,e){const n=Q(t);try{await ae(n)}catch{throw new Error(`File not found: ${t}`)}const s=await Xe(n);if(s.size>Se)throw new Error(`File too large: ${s.size} bytes. Maximum allowed: ${Se} bytes`);const r=ce(n).toLowerCase(),o=n.split("/").pop()||"";if((e||fn(n))==="utf-8"){if(!B.includes(r))throw new Error(`Unsupported text file type: ${r}. Supported types: ${B.join(", ")}`);let c;switch(r){case".txt":c="text/plain";break;case".md":case".markdown":c="text/markdown";break;default:c="text/plain"}const l=await F(n,"utf-8");return{path:n,content:l,mimeType:c,size:s.size,name:o,type:"text"}}else{let c,l;if(H.includes(r))switch(c="image",r){case".jpg":case".jpeg":l="image/jpeg";break;case".png":l="image/png";break;case".gif":l="image/gif";break;case".webp":l="image/webp";break;case".bmp":l="image/bmp";break;case".tiff":l="image/tiff";break;default:l="image/jpeg"}else if(W.includes(r))c="document",l="application/pdf";else throw new Error(`Unsupported file type: ${r}. Supported types: ${[...H,...W].join(", ")}`);const f=(await F(n)).toString("base64");return{path:n,base64:f,mimeType:l,size:s.size,name:o,type:c}}}a(q,"loadFileContent");function pn(t,e){return!t||typeof t!="object"?(e&&(e.value="Not an object"),!1):_n(t.using,e)?!t.jobs||typeof t.jobs!="object"?(e&&(e.value="Missing or invalid 'jobs' property"),!1):Re(t.jobs,e)?!0:(e&&(e.value=`Invalid 'jobs' property: ${e?.value}`),!1):(e&&(e.value=`Invalid 'using' property: ${e?.value}`),!1)}a(pn,"isJobConfig");function _n(t,e){if(!t||typeof t!="object")return e&&(e.value="Not an object"),!1;if(typeof t.engine!="string")return e&&(e.value="Missing or invalid 'engine' property"),!1;if(!["openai","anthropic","ollama","googleai"].includes(t.engine))return e&&(e.value="Invalid provider type. Must be 'openai', 'anthropic', 'googleai', or 'ollama'"),!1;switch(t.engine){case"ollama":if("model"in t&&typeof t.model!="string")return e&&(e.value="Property 'model' must be a string"),!1;if("url"in t&&typeof t.url!="string")return e&&(e.value="Property 'url' must be a string"),!1;break;case"googleai":case"anthropic":case"openai":if("api-key"in t&&typeof t["api-key"]!="string")return e&&(e.value="Property 'api-key' must be a string"),!1;if("model"in t&&typeof t.model!="string")return e&&(e.value="Property 'model' must be a string"),!1;break}return!0}a(_n,"isUsing");function Re(t,e){for(const[n,s]of Object.entries(t))if(!dn(s,e))return e&&(e.value=`Invalid job '${n}': ${e?.value}`),!1;return!0}a(Re,"isDAGJob");function dn(t,e){if(!t||typeof t!="object")return e&&(e.value="Not an object"),!1;if(!gn(t,e))return!1;if("dependsOn"in t&&t.dependsOn!==void 0){const n=t.dependsOn;if(typeof n!="string")if(Array.isArray(n)){for(let s=0;s<n.length;s++)if(typeof n[s]!="string")return e&&(e.value=`Dependency at index ${s} must be a string`),!1}else return e&&(e.value="Property 'dependsOn' must be a string or array of strings"),!1}return!0}a(dn,"isDAGJobValue");function gn(t,e){return!t||typeof t!="object"?(e&&(e.value="Not an object"),!1):"batch"in t?hn(t,e):mn(t,e)}a(gn,"isJob");function mn(t,e){if(!t||typeof t!="object")return e&&(e.value="Not an object"),!1;if("batch"in t)return e&&(e.value="Serial job should not have a batch property"),!1;if(t.tools!==void 0){if(!Array.isArray(t.tools))return e&&(e.value="Property 'tools' must be an array"),!1;for(const n of t.tools)if(typeof n!="string")return e&&(e.value="All tools must be strings"),!1}if(!Array.isArray(t.steps))return e&&(e.value="Property 'steps' must be an array"),!1;for(let n=0;n<t.steps.length;n++)if(!Ne(t.steps[n],e))return e&&(e.value=`Invalid step at index ${n}: ${e?.value}`),!1;return!0}a(mn,"isSerialJob");function hn(t,e){if(!t||typeof t!="object")return e&&(e.value="Not an object"),!1;if(t.tools!==void 0){if(!Array.isArray(t.tools))return e&&(e.value="Property 'tools' must be an array"),!1;for(const n of t.tools)if(typeof n!="string")return e&&(e.value="All tools must be strings"),!1}if(!Array.isArray(t.batch))return e&&(e.value="Property 'batch' must be an array"),!1;for(let n=0;n<t.batch.length;n++)if(!yn(t.batch[n],e))return e&&(e.value=`Invalid batch item at index ${n}: ${e?.value}`),!1;if(!Array.isArray(t.steps))return e&&(e.value="Property 'steps' must be an array"),!1;for(let n=0;n<t.steps.length;n++)if(!Ne(t.steps[n],e))return e&&(e.value=`Invalid step at index ${n}: ${e?.value}`),!1;return!0}a(hn,"isBatchJob");function yn(t,e){if(!t||typeof t!="object")return e&&(e.value="Not an object"),!1;if(t.type!=="files")return e&&(e.value="Property 'type' must be 'files'"),!1;if(typeof t.source!="string")return e&&(e.value="Property 'source' must be a string"),!1;if(typeof t.bind!="string")return e&&(e.value="Property 'bind' must be a string"),!1;if(t["skip-if"]!==void 0){if(!Array.isArray(t["skip-if"]))return e&&(e.value="Property 'skip-if' must be an array"),!1;for(let n=0;n<t["skip-if"].length;n++)if(!In(t["skip-if"][n],e))return e&&(e.value=`Invalid skip condition at index ${n}: ${e?.value}`),!1}return!0}a(yn,"isBatchOptions");function In(t,e){return!t||typeof t!="object"?(e&&(e.value="Not an object"),!1):t.type!=="file-exist"?(e&&(e.value="Property 'type' must be 'file-exist'"),!1):typeof t.pattern!="string"?(e&&(e.value="Property 'pattern' must be a string"),!1):!0}a(In,"isSkipOptions");function Ne(t,e){return!t||typeof t!="object"?(e&&(e.value="Not an object"),!1):!t.uses||typeof t.uses!="string"?(e&&(e.value="Step must have a string 'uses' property"),!1):t.uses==="chat"?En(t,e):t.uses==="write-to-disk"?wn(t,e):(e&&(e.value=`Unknown uses type: ${t.uses}`),!1)}a(Ne,"isStep");function En(t,e){if(!t||typeof t!="object")return e&&(e.value="Not an object"),!1;if(t.uses!=="chat")return e&&(e.value="Uses must be 'chat'"),!1;if(typeof t.message!="string")return e&&(e.value="Property 'message' must be a string"),!1;if(t.output!==void 0){if(!t.output||typeof t.output!="object"||Array.isArray(t.output))return e&&(e.value="Property 'output' must be an object"),!1;const n=["string","string[]","number","boolean"];for(const[s,r]of Object.entries(t.output))if(typeof s!="string"||typeof r!="string"||!n.includes(r))return e&&(e.value="Property 'output' must be a Record<string, ResTypeStrings> where ResTypeStrings is 'string' | 'string[]' | 'number' | 'boolean'"),!1}if(t.system!==void 0&&typeof t.system!="string")return e&&(e.value="Property 'system' must be a string"),!1;if(t.replace!==void 0){if(!Array.isArray(t.replace))return e&&(e.value="Property 'replace' must be an array"),!1;for(let n=0;n<t.replace.length;n++)if(!Tn(t.replace[n],e))return e&&(e.value=`Invalid replace at index ${n}: ${e?.value}`),!1}if(t.tools!==void 0){if(!Array.isArray(t.tools))return e&&(e.value="Property 'tools' must be an array"),!1;for(const n of t.tools)if(typeof n!="string")return e&&(e.value="All tools must be strings"),!1}if(t.images!==void 0){if(!Array.isArray(t.images))return e&&(e.value="Property 'images' must be an array"),!1;for(let n=0;n<t.images.length;n++)if(!vn(t.images[n],e))return e&&(e.value=`Invalid image at index ${n}: ${e?.value}`),!1}if(t.documents!==void 0){if(!Array.isArray(t.documents))return e&&(e.value="Property 'documents' must be an array"),!1;for(let n=0;n<t.documents.length;n++)if(!Pn(t.documents[n],e))return e&&(e.value=`Invalid document at index ${n}: ${e?.value}`),!1}if(t.references!==void 0){if(!Array.isArray(t.references))return e&&(e.value="Property 'references' must be an array"),!1;for(let n=0;n<t.references.length;n++)if(!An(t.references[n],e))return e&&(e.value=`Invalid reference at index ${n}: ${e?.value}`),!1}return!0}a(En,"isChatStep");function wn(t,e){if(!t||typeof t!="object")return e&&(e.value="Not an object"),!1;if(t.uses!=="write-to-disk")return e&&(e.value="Uses must be 'write-to-disk'"),!1;if(typeof t.output!="string")return e&&(e.value="Property 'output' must be a string"),!1;if(t.keys!==void 0&&typeof t.keys!="string")if(Array.isArray(t.keys)){for(let n=0;n<t.keys.length;n++)if(typeof t.keys[n]!="string")return e&&(e.value=`Key at index ${n} must be a string`),!1}else return e&&(e.value="Property 'keys' must be a string or array of strings"),!1;return!0}a(wn,"isWriteToDiskStep");function Tn(t,e){if(!t||typeof t!="object")return e&&(e.value="Not an object"),!1;if(typeof t.pattern!="string")return e&&(e.value="Property 'pattern' must be a string"),!1;if(t.source!=="file")return e&&(e.value="Property 'source' must be 'file'"),!1;if(typeof t.files!="string"&&!Array.isArray(t.files))return e&&(e.value="Property 'files' must be a string or an array of strings"),!1;if(Array.isArray(t.files)){for(let n=0;n<t.files.length;n++)if(typeof t.files[n]!="string")return e&&(e.value=`Files entry at index ${n} must be a string`),!1}return!0}a(Tn,"isReplace");function vn(t,e){return!t||typeof t!="object"?(e&&(e.value="Not an object"),!1):typeof t.file!="string"?(e&&(e.value="Property 'file' must be a string"),!1):!0}a(vn,"isImageReference");function Pn(t,e){return!t||typeof t!="object"?(e&&(e.value="Not an object"),!1):typeof t.file!="string"?(e&&(e.value="Property 'file' must be a string"),!1):!0}a(Pn,"isDocumentReference");function An(t,e){return!t||typeof t!="object"?(e&&(e.value="Not an object"),!1):typeof t.file!="string"?(e&&(e.value="Property 'file' must be a string"),!1):!0}a(An,"isTextFileReference");class Sn{static{a(this,"FileRunPlanner")}constructor(e,n,s=[]){this.source=e,this.bind=n,this.skipConditions=s}async plan(e){const n=[],s=await ie(this.source,{withFileTypes:!0});for(const r of s){const o=r.fullpath(),i=an(o);let c=!1;for(const l of this.skipConditions)if(c=await l.eval({components:i}),c)break;if(!c){const l=await Be(o,"utf-8"),u={variables:{[this.bind]:l,...i},tasks:e};n.push(u)}}return n}}class Rn{static{a(this,"MultiPlanner")}planners;constructor(e){this.planners=e}async plan(e){const n=this.planners.map(async r=>await r.plan(e));return(await Promise.all(n)).flat()}}function V(t,e,n="{{}}"){const s=n==="{{}}"?/\{\{(.*?)\}\}/g:/\{(.*?)\}/g;return t=t.replace(s,(r,o)=>{if(o=o.trim(),Object.prototype.hasOwnProperty.call(e,o)){const i=e[o];return i==null?"":String(i)}return r}),t}a(V,"replaceVariables");class Nn{static{a(this,"FileExistSkipCondition")}constructor(e){this.pattern=e}type="file-exist";async eval(e){const n=V(this.pattern,e.components,"{}");try{return await qe(n,Je.F_OK),!0}catch{return!1}}}function J(t,e=0){const n={};for(const[s,r]of Object.entries(t))if(typeof r=="string")switch(r){case"string":n[s]=e===0?I.string():I.string().optional();break;case"number":n[s]=e===0?I.number():I.number().optional();break;case"boolean":n[s]=e===0?I.boolean():I.boolean().optional();break;case"string[]":n[s]=I.array(I.string());break;default:throw new Error(`Unsupported declarative type: ${r}`)}else if(Array.isArray(r))if(r.length===1&&typeof r[0]=="object"){const o=J(r[0],e+1);n[s]=I.array(I.object(o))}else throw new Error(`Unsupported array format for key ${s}. Expected [DeclarativeSchema].`);else n[s]=I.object(J(r,e+1));return n}a(J,"declarativeToOutputSchema");function X(t){if(t instanceof I.ZodString)return["string","Your answer"];if(t instanceof I.ZodNumber)return["number",42];if(t instanceof I.ZodBoolean)return["boolean",!0];if(t instanceof I.ZodArray){const e=t.element;if(e instanceof I.ZodString)return["string array",["answer 1","answer 2","third answer"]];if(e instanceof I.ZodNumber)return["number array",[42,59,3.14]];if(e instanceof I.ZodBoolean)return["boolean array",[!0,!1,!1]];if(e instanceof I.ZodObject){const[n,s]=X(e);return["object array",[s,s]]}return["array",[]]}if(t instanceof I.ZodObject){const e=t.shape,n={};for(const[s,r]of Object.entries(e)){const[o,i]=X(r);n[s]=i}return["JSON object",n]}if(t instanceof I.ZodOptional){const e=t.unwrap(),[n,s]=X(e);return[`${n} | undefined`,s]}}a(X,"zodToExample");function Oe(t){return typeof t=="object"&&Object.values(t).every(e=>e&&typeof e=="object"&&"_def"in e)}a(Oe,"isOutputSchema");class be{static{a(this,"AbstractInstruct")}type="instruct";prompt;system=null;inputs={};tools={};files=[];textReferences=[];instructions=[];schema;rawResponse;_taggedSections=void 0;_result=void 0;constructor(e,n){this.prompt=e,this.schema=n}setInputs(e){this.inputs=e}addInput(e,n){this.inputs[e]=n}addTools(e){for(const n of e)this.tools[n.name]=n}addTool(e){this.tools[e.name]=e}addImage(e){if(e.type!=="image")throw new Error(`Expected image file, got ${e.type}`);const n=e;this.files.push(n)}addDocument(e){if(e.type!=="document")throw new Error(`Expected document file, got ${e.type}`);const n=e;this.files.push(n)}addFile(e){if(!ln(e))throw new Error(`Expected image or document file, got ${e.type}`);this.files.push(e)}addReference(e,n){if(typeof e=="string"){this.textReferences.push({content:e,name:n?.name});return}if(un(e))this.textReferences.push({content:e.content,name:n?.name??e.name});else throw new Error(`Expected text file, got ${e.type}`)}addInstructions(e){if(typeof e!="string"||e.trim()==="")throw new Error("Instruction must be a non-empty string");this.instructions.push(e)}hasTools(){return Object.keys(this.tools).length>0}hasFiles(){return this.files.length>0}get result(){return this._result}compile(e,n={}){const s=this.createUserMessage(e,n),r=this.createInstructions();return{message:s,instructions:r}}createUserMessage(e,n={}){const{recorder:s,options:r}=n,o={...e,...this.inputs};let i=V(this.prompt,o);if(this.textReferences.length>0)for(const[c,l]of this.textReferences.entries()){const u=l.name?`: ${l.name}`:"";i+=`

## Reference ${c+1}${u}

\`\`\`${l.content}'''`}if(r?.warnUnused){const c=i.match(/\{\{(.*?)\}\}/g);if(c)throw s?.error.log(`Warning unused variables ${c.join(", ")}`),new Error(`Unused variables: ${c.join(", ")}`)}return i}createInstructions(e=""){if(e=`# Instructions

`+e,Object.keys(this.schema).length>0){e+=`## Output Format Instructions
`,e+=`
Here is how you should format your output. Follow the instructions strictly.
`;for(const[s,r]of Object.entries(this.schema)){const o=this.generateFieldInstructions(s,r);e+=o}}if(this.instructions.length>0){e+=`
## Additional Instructions

`;for(const s of this.instructions)e+=`- ${s}
`}return e}generateFieldInstructions(e,n){const[s,r]=X(n);return`
- Use <${e}></${e}> tags to indicate the answer for ${e}. The answer must be a ${s}.
  Example: <${e}>${JSON.stringify(r)}</${e}>
`}finalize(e,n={}){const{recorder:s}=n;if(this.rawResponse=e,Object.keys(this.schema).length===0){if(e.trim()==="{}"||e.trim()==="")return this._result={},this._result;throw new Error("Schema is empty, but rawValue is not an empty object representation or empty string.")}this._taggedSections=this._taggedSections||this.parseTaggedSections(e);const o={};for(const[i,c]of Object.entries(this.schema)){const l=this._taggedSections.tags[i];if(l!==void 0)o[i]=this.preprocessValue(c,l);else if(c.def.type!=="optional")throw new Error(`Expected results with tag ${i} but it does not exist`)}try{const i={};for(const[c,l]of Object.entries(this.schema))c in o&&(i[c]=l.parse(o[c]));return this._result=i,this._result}catch(i){if(i&&typeof i=="object"&&"issues"in i){const c=i.issues.map(l=>`${l.path.join(".")}: ${l.message}`).join(", ");throw new Error(`Validation failed: ${c}`)}throw i}}preprocessValue(e,n){switch(n=n.trim(),e.def.type){case"string":try{return JSON.parse(n)}catch{if(typeof n=="string")return n;throw new Error(`Cannot parse '${n}' as string. Ensure it is a valid JSON string or a plain string.`)}case"number":{const s=parseFloat(n);if(isNaN(s))throw new Error(`Cannot parse '${n}' as number`);return s}case"boolean":{const s=n.toLowerCase();if(s==="true")return!0;if(s==="false")return!1;throw new Error(`Cannot parse '${n}' as boolean. Expected 'true' or 'false'`)}case"array":{if(n==="")return[];try{const s=JSON.parse(n);if(Array.isArray(s))return s}catch{}if(n.includes(","))return n.split(",").map(s=>{const r=s.trim();try{return JSON.parse(r)}catch{return r}}).filter(s=>s!=="")}case"object":{n.includes("```json")&&(n=n.replace(/```json/g,"").replace(/```/g,""));try{return JSON.parse(n)}catch(s){throw new Error(`Cannot parse object as JSON: ${s.message}`)}}case"optional":{const s=e.def.innerType;return this.preprocessValue(s,n)}default:return n}}parseTaggedSections(e){e.trim().startsWith("```json")&&e.trim().endsWith("```")&&(e=e.trim().slice(7,-3).trim());const n=/<(\w+)>(.*?)<\/\1>/gs,s={};let r=e;r=r.replace(n,(i,c,l)=>(s[c]=l,""));const o=/<(\w+)>(.*?)(?:<\/?\w+>|$)/gs;return r=r.replace(o,(i,c,l)=>(s[c]=l,"")),{tags:s,remaining:r.trim()}}}class M extends be{static{a(this,"Instruct")}constructor(e,n){super(e,n)}static with(e,n){if(!n)return new M(e,{response:I.string()});if(Oe(n))return new M(e,n);{const s=J(n);return new M(e,s)}}}function U(t){return Array.isArray(t)?t:[t]}a(U,"arrayify");function S(t,e){return e?`${e}:${t.slice(0,8)}`:t.slice(0,8)}a(S,"friendly");function On(t){return new Promise(e=>setTimeout(e,t))}a(On,"delay");const bn={name:"brave",description:"Perform a search using the Brave search engine",parameters:{type:"object",properties:{searchTerm:{type:"string",description:"The search term to query"}},required:["searchTerm"]}};class xn{static{a(this,"BraveSearchTool")}name="brave";schema=bn;apiKey;throttle;lastExecTime=0;constructor(e){e&&this.setConfig(e)}setConfig(e){const{rateLimit:n}=e;this.apiKey=e["api-key"],this.throttle=n?1100/n:void 0}async execute(e,n={}){const{searchTerm:s}=e,{recorder:r}=n;if(r?.debug?.heading.log(`Brave: searching for ${s}`),this.throttle){for(;Date.now()-this.lastExecTime<this.throttle;)await On(this.throttle-(Date.now()-this.lastExecTime));this.lastExecTime=Date.now()}try{const o=this.apiKey,i="https://api.search.brave.com/res/v1/web/search",c=new URL(i);c.searchParams.append("q",s),c.searchParams.append("format","json");const l=await fetch(c.toString(),{method:"GET",headers:{Accept:"application/json","X-Subscription-Token":o}});if(!l.ok)throw new Error(`[Brave] HTTP error ${l.status}: ${l.statusText}`);return await l.json()}catch(o){throw r?.error.log("[Brave] Error fetching search results:",o),o}}}const kn=new xn,Mn={name:"calculator",description:"Performs basic arithmetic operations",parameters:{type:"object",properties:{operation:{type:"string",description:"The operation to perform (add, subtract, multiply, divide)",enum:["add","subtract","multiply","divide"]},a:{type:"number",description:"First operand"},b:{type:"number",description:"Second operand"}},required:["operation","a","b"]}},$n={name:"calculator",schema:Mn,execute:a(async t=>{const{operation:e,a:n,b:s}=t;switch(e){case"add":return`${n} + ${s} = ${n+s}`;case"subtract":return`${n} - ${s} = ${n-s}`;case"multiply":return`${n} * ${s} = ${n*s}`;case"divide":if(s===0)throw new Error("Cannot divide by zero");return`${n} / ${s} = ${n/s}`;default:throw new Error(`Unknown operation: ${e}`)}},"execute")};class Gn{static{a(this,"ToolRegistry")}executables={};config;setConfig(e){this.config=e}register(e){if(this.executables[e.name])throw new Error(`Tool with name '${e.name}' is already registered`);this.executables[e.name]=e}get(e){const n=this.executables[e];if(!n)throw new Error(`Tool '${e}' is not registered`);return n.setConfig?.(this.config[e]),n}}let D;function xe(){return D||(D=new Gn,D.register($n),D.register(kn)),D}a(xe,"getToolRegistry");const Cn={async convert(t,e){const{recorder:n,toolNames:s}=e,{message:r,system:o,replace:i}=t;let c;t.output?c=M.with(r,t.output):c=M.with(r),o&&(c.system=o);const l=[...new Set([...s??[],...t.tools??[]])];for(const u of l){const f=xe().get(u);c.addTool(f)}if(i){for(const u of i)if(u.source==="file"){const f=U(u.files),p=await rn(f,n);c.addInput(u.pattern,p)}}if(t.images)for(const u of t.images)try{const f=await q(u.file,"base64");c.addFile(f)}catch(f){throw new Error(`Failed to load image '${u.file}': ${f.message}`)}if(t.documents)for(const u of t.documents)try{const f=await q(u.file,"base64");c.addFile(f)}catch(f){throw new Error(`Failed to load document '${u.file}': ${f.message}`)}if(t.references)for(const u of t.references)try{const f=await q(u.file,"utf-8");c.addReference(f)}catch(f){throw new Error(`Failed to load reference file '${u.file}': ${f.message}`)}return c}};class Ln{static{a(this,"StepToClassRegistry")}converters=new Map;get(e){const n=this.converters.get(e);if(!n)throw new Error(`No converter registered for step: ${e}`);return n}register(e,n){this.converters.set(e,n)}}class ee{static{a(this,"WriteOutputTask")}constructor(e,n=["response"]){this.output=e,this.keys=n}type="write-to-disk"}const Fn={async convert(t){if(t.keys){const e=U(t.keys);return new ee(t.output,e)}return new ee(t.output)}},te=new Ln;te.register("write-to-disk",Fn),te.register("chat",Cn);async function K(t,e){const{recorder:n}=e,s=t.tools??void 0,r=t.steps.map(async o=>(o.uses,await te.get(o.uses).convert(o,{recorder:n,toolNames:s})));return Promise.all(r)}a(K,"configToTasks");async function ke(t,e){const{batch:n}=t;return n.length===1?Me(n[0]):new Rn(n.map(s=>Me(s)))}a(ke,"configToPlanner");function Me(t){switch(t.type){case"files":let e;return t["skip-if"]&&(e=t["skip-if"].map(s=>Un(s))),new Sn(t.source,t.bind,e)}}a(Me,"batchOptionsToPlanner");function Un(t){switch(t.type){case"file-exist":return new Nn(t.pattern)}}a(Un,"skipOptionsToSkipConditions");function Dn(t){return t.success===!1&&t.error!==void 0}a(Dn,"isErrorResult");function j(t,e){return{response:t,stats:e,success:!0}}a(j,"createResult");function z(t,e,n){return{response:e,stats:n,error:t,success:!1}}a(z,"createErrorResult");class Hn{static{a(this,"WriteToDiskTaskHandler")}taskType="write-to-disk";canHandle(e){return e&&typeof e=="object"&&"type"in e&&e.type==="write-to-disk"}async execute(e){const{task:n,variables:s,options:r={},recorder:o}=e,i=n.output,c=n.keys??[];if(r?.warnUnused){const f=c.filter(p=>!(p in s));f.length>0&&o?.warn?.log(`[Write To Disk] The following keys were not found in the variables: ${f.join(", ")}`)}let l="";if(c.length===1?l=s[c[0]]??"<not found>":l=c.map(f=>`[${f}]:
${s[f]??"<not found>"}
`).join(`
`),r?.dryRun){o?.info?.log("[Dry run] Write to Disk is not executed.");return}let u="";i.includes("*")?u=on(i,s.file):u=V(i,s,"{}"),await cn({filePath:u,content:l})}}var Z=(t=>(t.LastResult="lastResult",t))(Z||{});function Wn(t,e,n){const{options:s,recorder:r}=n,o=s?.warnUnused??!0;for(const[i,c]of Object.entries(t))o&&e[i]&&r?.warn?.log(`Warning: Variable "${i}" is being overwritten. Previous value: ${e[i]}, new value: ${c}`),e[i]=c}a(Wn,"setResultsIntoVariables");class Bn{static{a(this,"ChatTaskHandler")}taskType="instruct";canHandle(e){return e&&typeof e=="object"&&"type"in e&&e.type==="instruct"}async execute(e){const{task:n,...s}=e;await qn({instruct:n,...s})}}async function qn(t){const{instruct:e,chat:n,provider:s,stats:r,variables:o,options:i,recorder:c}=t;e.system&&n.addSystem(e.system);const{message:l,instructions:u}=e.compile(o,{recorder:c,options:i});if(e.hasFiles()?n.addUser(l,u,e.files):n.addUser(l,u),e.hasTools()){const p=Xn(e.tools);n.setToolSchemas(p)}if(i?.dryRun)return c?.debug?.log(n),{action:"complete"};let f=!0;for(;f;){const g=await s.createChatRequest(n,{recorder:c}).execute({recorder:c});if(r.in+=g.usage.in,r.out+=g.usage.out,g.type==="error")throw new Error(JSON.stringify(g.error));if(g.type==="success")switch(g.reason){case w.Stop:{if(g.message.content){const y=g.message.content;n.addAssistant(y);const h=e.finalize(y,{recorder:c});Wn(h,o,{options:i,recorder:c}),o[Z.LastResult]=h}return f=!1,{action:"continue"}}case w.Length:throw new Error("Incomplete model output due to `max_tokens` parameter or token limit");case w.FunctionCall:{let y=g.message;if(g.message&&n.addAssistant(y.content,y.toolCalls),y.toolCalls&&y.toolCalls.length>0){const h=await Jn(y.toolCalls,e,{recorder:c});c?.debug?.log(h),n.addTools(h),f=!0}else f=!1;break}}if(g.type!=="success")throw c?.debug?.log(g),new Error("Unexpected response type")}return{action:"continue"}}a(qn,"executeChatAction");async function Jn(t,e,n={}){const{recorder:s}=n,r=[];for(const o of t)r.push(new Promise((i,c)=>{const l=e.tools[o.name];if(!l){c(`Tool not found: ${o.name}`);return}s?.debug?.heading.log(`Executing tool ${l.name}`);let u={};try{u=typeof o.arguments=="string"?JSON.parse(o.arguments):o.arguments}catch{c(`argument for tool ${o.name} is not valid: ${JSON.stringify(o.arguments)}`)}l.execute(u).then(f=>{s?.debug?.log(`Complete tool ${l.name}: ${o.id}`),i({id:o.id,name:o.name,content:JSON.stringify(f)})}).catch(c)}));return Promise.all(r)}a(Jn,"executeToolCalls");function Xn(t){const e=[];for(const[n,s]of Object.entries(t))e.push(s.schema);return e}a(Xn,"getToolSchemas");class Kn{static{a(this,"TaskRegistry")}handlers=new Map;register(e){this.handlers.set(e.taskType,e)}getHandler(e){return this.handlers.get(e.type)}hasHandler(e){return this.handlers.has(e.type)}async executeTask(e){const{task:n}=e,s=n.type,r=this.getHandler(n);if(!r)throw new Error(`No handler registered for action type: ${s}`);if(!r.canHandle(n))throw new Error(`Handler found but action does not match expected format: ${s}`);await r.execute(e)}}function jn(){const t=new Kn;return t.register(new Bn),t}a(jn,"createBaseRegistry");function zn(){const t=jn();return t.register(new Hn),t}a(zn,"createNodeRegistry");const ne=a((t,...e)=>{const n=a(async r=>{const{recorder:o}=r;let i=[];return"steps"in t?i=await K(t,{recorder:o}):i=[t,...e],i},"prepare");return{execute:a(async r=>{const{provider:o,variables:i,options:c,stats:l,recorder:u,name:f}=r,p=crypto.randomUUID(),g=zn();u?.info?.log({type:"task",id:p,status:m.Running,message:`[${S(p,f)}] Starting job`});try{const y=await n({recorder:u}),h=new Ze;for(const[b,A]of y.entries()){u?.info?.log({type:"task",id:p,status:m.Running,message:`[${S(p,f)}] Processing step ${b+1}: ${A.type}`});try{await g.executeTask({task:A,chat:h,provider:o,variables:i,options:c,stats:l,recorder:u})}catch(R){throw R instanceof v?R:new se(`Error executing task ${A.type}`,{id:p,taskType:A.type,taskIndex:b,cause:R instanceof Error?R:new Error(String(R))})}}return u?.info?.log({type:"task",status:m.Success,id:p,message:`[${S(p,f)}] Completed ${y.length} steps`}),j(i[Z.LastResult],l)}catch(y){const h=y instanceof v?y:new v("Serial workflow execution failed",{id:p,cause:y instanceof Error?y:new Error(String(y))});return u?.info?.log({type:"task",status:m.Fail,id:p,message:`[${S(p,f)}] Failed: ${h.message}`}),u?.error.log(h),z(h,i[Z.LastResult],l)}},"execute")}},"serialWorkflow"),$e=a((t,...e)=>{const n=a(async r=>{const{recorder:o}=r;let i=[],c=null;if("batch"in t){const l=t;c=await ke(l),i=await K(l,{recorder:o})}else c=t,i=[...e];return[c,i]},"prepare");return{execute:a(async r=>{const{provider:o,variables:i,options:c,stats:l,recorder:u,name:f}=r,p=crypto.randomUUID();try{const[g,y]=await n({recorder:u}),h=await g.plan(y);if(u?.debug?.heading.log("Runs",h),h.length===0)return u?.info?.log("No runs to execute"),j([],l);let b=0;u?.info?.log({type:"task",status:m.Running,id:p,message:`[${S(p,"CRW")}] Working on 0/${h.length}`});const A=a(async(N,Y)=>{try{return await ne(...N.tasks).execute({provider:o,variables:{...N.variables,...i},options:c,stats:l,recorder:u,name:`${f}-${Y}`})}catch(x){const re=x instanceof v?x:new v("Error executing run",{cause:x instanceof Error?x:new Error(String(x))});return u?.error?.log(re),z(re,null,l)}finally{b++,u?.info?.log({type:"task",status:m.Running,id:p,message:`[${S(p,"CRW")}] Working on ${b}/${h.length}`})}},"executeRun"),R=5;let $=[];for(let N=0;N<h.length;N+=R){const Y=h.slice(N,N+R),x=await Promise.all(Y.map(A));$=$.concat(x)}const k=$.some(Dn);u?.info?.log({type:"task",status:k?m.PartialSuccess:m.Success,id:p,message:`[${S(p,"CRW")}] All jobs (${h.length}) completed${k?" with some errors":""}`});const C=$.map(N=>N.response);return j(C,l)}catch(g){const y=g instanceof v?g:new v("Concurrent workflow execution failed",{id:p,cause:g instanceof Error?g:new Error(String(g))});return u?.error?.log(y),z(y,null,l)}},"execute")}},"concurrentWorkflow");class Zn{static{a(this,"DAGParser")}static parse(e){const n=new Map;for(const[r,o]of Object.entries(e)){const i=this.parseNodeDefinition(r,o);n.set(r,i)}return this.validateDependencies(n),this.checkForCycles(n),{stages:this.createExecutionStages(n),nodes:n}}static parseNodeDefinition(e,n){if(this.isSimpleTask(n))return{id:e,tasks:Array.isArray(n)?n:[n],dependencies:[],executionType:"serial"};if(this.isConcurrentNodeDefinition(n)){const i=n,c=i.dependsOn?U(i.dependsOn):[];return{id:e,tasks:i.tasks,dependencies:c,planner:i.planner,executionType:"concurrent"}}const s=n,r=s.dependsOn?U(s.dependsOn):[],o=U(s.task);return{id:e,tasks:o,dependencies:r,executionType:"serial"}}static isSimpleTask(e){return e.type||Array.isArray(e)}static isConcurrentNodeDefinition(e){return e&&typeof e=="object"&&"planner"in e}static validateDependencies(e){for(const n of e.values())for(const s of n.dependencies)if(!e.has(s))throw new v(`Node "${n.id}" depends on non-existent node "${s}"`)}static checkForCycles(e){const n=new Set,s=new Set,r=a(o=>{if(s.has(o))return!0;if(n.has(o))return!1;n.add(o),s.add(o);const i=e.get(o);for(const c of i.dependencies)if(r(c))return!0;return s.delete(o),!1},"hasCycle");for(const o of e.keys())if(r(o))throw new v(`Circular dependency detected involving node "${o}"`)}static createExecutionStages(e){const n=[],s=new Set,r=new Set(e.keys());for(;r.size>0;){const o=[];for(const i of r)e.get(i).dependencies.every(u=>s.has(u))&&o.push(i);if(o.length===0)throw new v("Unable to resolve DAG dependencies - possible circular reference");n.push(o),o.forEach(i=>{s.add(i),r.delete(i)})}return n}}class Yn{static{a(this,"DAGJobToDefinition")}static async convert(e,n){const{recorder:s}=n,r={};for(const[o,i]of Object.entries(e)){const{dependsOn:c,...l}=i;if("batch"in l){const u=l,f=await ke(u),p=await K(u,{recorder:s}),g={planner:f,tasks:p,...c?{dependsOn:c}:{}};r[o]=g}else{const u=await K(l,{recorder:s});if(c){const f={task:u,dependsOn:c};r[o]=f}else r[o]=u}}return r}}async function Qn(t,e,n,s={}){const{variables:r}=n,o=e.nodes.get(t);try{let i;if(o.executionType==="concurrent"&&o.planner?i=await $e(o.planner,...o.tasks).execute({...n,variables:r,name:t}):i=await ne(...o.tasks).execute({...n,variables:r,name:t}),!i.success)throw new v(`Node "${t}" failed: ${i.error?.message}`);return i.response}catch(i){if(!s.continueOnError)throw i;return null}}a(Qn,"executeNode");const Vn=a((t,e={})=>{const n=a(async(r,o)=>{const{recorder:i}=o,c={value:""};return Re(r,c)?await Yn.convert(r,o):(i?.warn?.log(c),r)},"prepare");return{execute:a(async r=>{const{stats:o,recorder:i}=r,{maxConcurrency:c=3}=e,l=crypto.randomUUID();try{const u=await n(t,{recorder:i});i?.debug?.log(u);const f=Zn.parse(u),p=new Map;i?.info?.log({type:"task",id:l,status:m.Running,message:`[${S(l)}] Starting workflow execution with ${f.stages.length} stages`});for(const[y,h]of f.stages.entries()){i?.info?.log({type:"task",id:l,status:m.Running,message:`[${S(l)}] Stage ${y+1}/${f.stages.length}, executing ${h.length} nodes: ${h.join(", ")}`});const b=Math.min(h.length,c);for(let A=0;A<h.length;A+=b){const R=h.slice(A,A+b);(await Promise.all(R.map(async k=>{const C=await Qn(k,f,r,e);return{nodeId:k,result:C}}))).forEach(({nodeId:k,result:C})=>{p.set(k,C)})}}i?.info?.log({type:"task",status:m.Success,id:l,message:`[${S(l)}] Workflow execution completed successfully`});const g=Object.fromEntries(p);return j(g,o)}catch(u){const f=u instanceof v?u:new v("DAG workflow execution failed",{id:l,cause:u instanceof Error?u:new Error(String(u))});return i?.info?.log({type:"task",status:m.Fail,id:l,message:`[${S(l)}] Workflow execution failed: ${f.message}`}),i?.error?.log(f),z(f,null,o)}},"execute")}},"dagWorkflow"),es=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"],G={success:"\u2713",fail:"\u2717",spinning:es};class ts{static{a(this,"ConsoleWriter")}tasks=new Map;entries=[];truncate=0;intervalId=null;spinnerInterval=80;lastRender="";isRendering=!1;inline=!0;constructor(e={}){this.truncate=e.truncate??0,this.inline=e.inline??!0}startSpinner(){this.intervalId===null&&(this.intervalId=setInterval(()=>{[...this.tasks.values()].some(n=>n.status===m.Running)&&this.renderTasks()},this.spinnerInterval))}stopSpinner(){this.intervalId!==null&&(clearInterval(this.intervalId),this.intervalId=null)}renderTasks(){if(this.isRendering)return;if(this.isRendering=!0,this.inline&&this.lastRender){const o=this.lastRender.split(`
`).length;ue.moveCursor(process.stdout,0,-o+1),ue.clearScreenDown(process.stdout)}const e=[...this.tasks.values()],n=e.filter(o=>o.status===m.Running),s=e.filter(o=>o.status===m.Success||o.status===m.Fail);if(n.length===0&&s.length>0){let o="";for(const i of s){if(i.status===m.Success){const c=E.green(G.success);o+=`${c} ${i.text}
`}else if(i.status===m.Fail){const c=E.red(G.fail);o+=`${c} ${i.text}
`}this.tasks.delete(i.id)}console.log(o)}for(const o of this.entries){const{level:i,time:c,kind:l,payload:u}=o;l==="heading"?ss(i,u,{truncate:this.truncate}):rs(i,u,{truncate:this.truncate})}this.entries=[];let r="";for(const o of this.tasks.values())if(o.status===m.Running){const i=E.cyan(G.spinning[o.frameIndex]);o.frameIndex=(o.frameIndex+1)%G.spinning.length,r+=`${i} ${o.text}
`}else if(o.status===m.Success){const i=E.green(G.success);r+=`${i} ${o.text}
`}else if(o.status===m.Fail){const i=E.red(G.fail);r+=`${i} ${o.text}
`}this.lastRender=r,process.stdout.write(r),this.isRendering=!1}handleEvent(e){const{level:n,time:s,payload:r}=e;if(r.length>0&&ns(r[0])){const i=r[0],{id:c,message:l,status:u}=i;if(u===m.Running)this.tasks.set(c,{id:c,text:l,status:u,frameIndex:0});else if((u===m.Success||u===m.Fail)&&this.tasks.has(c)){const f=this.tasks.get(c);f.status=u,f.text=l}}else this.entries.push(e);this.renderTasks();const o=[...this.tasks.values()].some(i=>i.status===m.Running);o&&this.intervalId===null?this.startSpinner():!o&&this.intervalId!==null&&this.stopSpinner()}destroy(){this.stopSpinner()}}function ns(t){if(typeof t!="object"||t===null)return!1;const e=t;if(e.type!=="task"||typeof e.id!="string"||typeof e.message!="string")return!1;switch(e.status){case m.Running:case m.Success:case m.PartialSuccess:case m.Fail:return!0;default:return!1}}a(ns,"isTask");function ss(t,e,n){let s,r;t===T.Error?(s=E.red,r=E.redBright.bold):t===T.Warn?(s=E.yellow,r=E.yellowBright.bold):t>=T.Info?(s=E.blue,r=E.whiteBright.bold):(s=E.gray,r=E.white);const{message:o,data:i}=Le(e);console.log(`${s("==>")} ${r(o)}`),Ce(t,i,n)}a(ss,"heading");function rs(t,e,n){let s;t===T.Error?s=E.red:t===T.Warn?s=E.yellow:t>=T.Info?s=E.white:s=E.gray;const{message:r,data:o}=Le(e);r&&console.log(s(r)),Ce(t,o,n)}a(rs,"body");const Ge="    ";function Ce(t,e,n){let s;t===T.Error?(s=E.red,n.truncate=0):t==T.Warn?s=E.yellow:t>=T.Info?s=E.white:s=E.gray,e.forEach(r=>{if(typeof r=="string"){console.log(s(`${Ge}${r}`));return}for(const[o,i]of Object.entries(r)){let c=JSON.stringify(i,os(n.truncate),"	");const l=`${o}: ${c}`.split(`
`).map(u=>Ge+u).join(`
`);console.log(s(l))}})}a(Ce,"values");function Le(t){const[e,...n]=t;let s="",r=n;if(e){let{message:o,...i}=e;s=o&&typeof o=="string"?o:"",Object.keys(i).length>0&&(r=[i,...r])}return{message:s,data:r}}a(Le,"toMsgData");function os(t){return t===0?null:(e,n)=>typeof n=="string"&&n.length>t?n.slice(0,t)+"<...>":n}a(os,"truncator");export{v as A,ts as C,M as I,T as L,nn as R,ee as W,be as a,J as b,$e as c,Vn as d,sn as e,pn as f,tn as g,xe as h,Oe as i,q as l,ne as s};
