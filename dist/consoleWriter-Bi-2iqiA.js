var De=Object.defineProperty;var u=(t,e)=>De(t,"name",{value:e,configurable:!0});import Fe from"@anthropic-ai/sdk";import*as x from"zod";import f,{z as L}from"zod";import{FinishReason as O,GoogleGenAI as Ue}from"@google/genai";import We from"openai";import{serializeError as Le}from"serialize-error";import{readFile as qe,access as Be,constants as Je}from"fs/promises";import{glob as ie}from"glob";import{readFile as D,access as ce,stat as He,writeFile as Ve,mkdir as Ze}from"node:fs/promises";import{resolve as Q,extname as le,dirname as ze}from"node:path";import E from"chalk";import ue from"node:readline";class k extends Error{static{u(this,"AxleError")}code;id;details;constructor(e,n){super(e,{cause:n?.cause}),this.name=this.constructor.name,this.code=n?.code||"AXLE_ERROR",this.id=n?.id,this.details=n?.details,Object.setPrototypeOf(this,k.prototype)}}const Ke={CLAUDE_HAIKU_4_5:"claude-haiku-4-5"},Xe=Ke.CLAUDE_HAIKU_4_5;var _=(t=>(t[t.Stop=0]="Stop",t[t.Length=1]="Length",t[t.FunctionCall=2]="FunctionCall",t[t.Error=3]="Error",t[t.Custom=4]="Custom",t))(_||{});class Ye{static{u(this,"Chat")}system;messages=[];tools=[];setTools(e){this.tools=e}addSystem(e){this.system=e}addUser(e,n,s){let o,r=[];if(typeof n=="string"?(o=n,r=s||[]):Array.isArray(n)&&(r=n),!o&&r.length===0){this.messages.push({role:"user",content:e});return}const a=[{type:"text",text:e}];o&&a.push({type:"instructions",instructions:o});for(const c of r)a.push({type:"file",file:c});this.messages.push({role:"user",content:a})}addAssistant(e){if(typeof e=="string"){const n=e;this.messages.push({role:"assistant",id:crypto.randomUUID(),content:[{type:"text",text:n}],model:"user",finishReason:_.Custom})}else this.messages.push({role:"assistant",...e})}addTools(e){this.messages.push({role:"tool",content:e})}hasFiles(){return this.messages.some(e=>Array.isArray(e.content)&&e.content.some(n=>n.type==="file"))}latest(){return this.messages[this.messages.length-1]}toString(){return JSON.stringify({system:this.system,messages:this.messages,tools:this.tools})}}function Qe(t,e=`

`){if(typeof t=="string")return t;const n=t.filter(o=>o.type==="text").map(o=>o.text),s=t.filter(o=>o.type==="instructions").map(o=>o.instructions);return n.length===0&&s.length===0?null:[...n,...s].join(e)}u(Qe,"getTextAndInstructions");function M(t){return typeof t=="string"?t:t.filter(e=>e.type==="text").map(e=>e.text).join(`

`)}u(M,"getTextContent");function et(t){return typeof t=="string"?[]:t.filter(e=>e.type==="file"&&e.file.type==="document").map(e=>e.file)}u(et,"getDocuments");function tt(t){return typeof t=="string"?[]:t.filter(e=>e.type==="file"&&e.file.type==="image").map(e=>e.file)}u(tt,"getImages");function F(t){if(t==null)return{type:"error",error:{type:"Undetermined",message:"Unknown error occurred"},usage:{in:0,out:0},raw:t};if(t instanceof Error)return{type:"error",error:{type:t.name||"Error",message:t.message||"Unexpected error"},usage:{in:0,out:0},raw:t};if(typeof t=="object"){const e=t,n=e?.error?.error?.type||e?.error?.type||e?.type||e?.code||e?.status||"Undetermined",s=e?.error?.error?.message||e?.error?.message||e?.message||e?.error||"Unexpected error";return{type:"error",error:{type:String(n),message:String(s)},usage:{in:0,out:0},raw:t}}return{type:"error",error:{type:"Undetermined",message:String(t)},usage:{in:0,out:0},raw:t}}u(F,"getUndefinedError");function pe(t){return t.map(e=>{if(e.role==="assistant"){const n=[];return n.push(...nt(e.content)),e.toolCalls&&n.push(...e.toolCalls.map(s=>({type:"tool_use",id:s.id,name:s.name,input:s.parameters}))),{role:"assistant",content:n}}if(e.role==="tool")return{role:"user",content:e.content.map(n=>({type:"tool_result",tool_use_id:n.id,content:n.content}))};if(typeof e.content=="string")return{role:"user",content:e.content};{const n=[],s=Qe(e.content);s&&n.push({type:"text",text:s});const o=tt(e.content);o.length>0&&n.push(...o.map(a=>({type:"image",source:{type:"base64",media_type:a.mimeType,data:a.base64}})));const r=et(e.content);return r.length>0&&n.push(...r.filter(a=>a.mimeType==="application/pdf").map(a=>({type:"document",source:{type:"base64",media_type:"application/pdf",data:a.base64}}))),{role:"user",content:n}}})}u(pe,"convertToProviderMessages");function de(t){return t.map(e=>{const n=f.toJSONSchema(e.schema);if(!rt(n))throw new Error(`Schema for tool ${e.name} must be an object type`);return{name:e.name,description:e.description,input_schema:n}})}u(de,"convertToProviderTools");function fe(t){const e=[];for(const n of t)n.type==="text"?e.push({type:"text",text:n.text}):n.type==="thinking"?e.push({type:"thinking",text:n.text||"",redacted:!1}):n.type==="redacted_thinking"&&e.push({type:"thinking",text:n.text||"",redacted:!0});return e}u(fe,"convertToAxleContentParts");function nt(t){const e=[];for(const n of t)n.type==="text"?e.push({type:"text",text:n.text}):n.type==="thinking"&&(n.redacted?e.push({type:"redacted_thinking",data:n.text}):e.push({type:"thinking",thinking:n.text,signature:n.signature}));return e}u(nt,"converToProviderContentParts");function st(t){return t.slice(1).map(e=>{if(e.type==="tool_use"){if(typeof e.input!="object"||e.input===null||Array.isArray(e.input))throw new Error(`Invalid tool call input for ${e.name}: expected object, got ${typeof e.input}`);return{type:"tool-call",id:e.id,name:e.name,parameters:e.input}}}).filter(e=>e)}u(st,"convertToAxleToolCalls");function ee(t){switch(t){case"max_tokens":return _.Length;case"end_turn":return _.Stop;case"stop_sequence":return _.Stop;case"tool_use":return _.FunctionCall;case"pause_turn":case"refusal":default:return _.Error}}u(ee,"convertStopReason$2");function rt(t){return t&&typeof t=="object"&&t.type==="object"}u(rt,"isObjectSchema");async function ot(t){const{client:e,model:n,messages:s,system:o,tools:r,context:a,options:c}=t,{recorder:l}=a,i=c?{...c}:{};i.stop&&(i.stop_sequences=Array.isArray(i.stop)?i.stop:[i.stop],delete i.stop);const p={model:n,max_tokens:4096,messages:pe(s),...o&&{system:o},...r&&{tools:de(r)},...i};l?.debug?.log(p);let d;try{const g=await e.messages.create(p);d=at(g)}catch(g){d=F(g)}return l?.debug?.log(d),d}u(ot,"createGenerationRequest$2");function at(t){const e=ee(t.stop_reason);if(e===_.Error)return{type:"error",error:{type:"Uncaught error",message:`Stop reason is not recognized or unhandled: ${t.stop_reason}`},usage:{in:t.usage.input_tokens,out:t.usage.output_tokens},raw:t};if(e===_.FunctionCall){const n=fe(t.content);return{type:"success",id:t.id,model:t.model,role:t.role,finishReason:_.FunctionCall,content:n,text:M(n)??"",toolCalls:st(t.content),usage:{in:t.usage.input_tokens,out:t.usage.output_tokens},raw:t}}if(t.type=="message"){const n=fe(t.content);return{type:"success",id:t.id,model:t.model,role:"assistant",finishReason:e,content:n,text:M(n)??"",usage:{in:t.usage.input_tokens,out:t.usage.output_tokens},raw:t}}}u(at,"convertToAIResponse");function it(){const t=new Map;function e(n){const s=[];switch(n.type){case"message_start":s.push({type:"start",id:n.message.id,data:{model:n.message.model,timestamp:Date.now()}});break;case"message_delta":n.delta.stop_reason&&s.push({type:"complete",data:{finishReason:ee(n.delta.stop_reason),usage:n.usage?{in:n.usage.input_tokens||0,out:n.usage.output_tokens||0}:void 0}});case"message_stop":break;case"content_block_start":if(n.content_block.type==="text")n.index;else if(n.content_block.type==="tool_use"){const r=n.content_block;t.set(n.index,{id:r.id,name:r.name,argumentsBuffer:""}),s.push({type:"tool-call-start",data:{index:n.index,id:r.id,name:r.name}})}else n.content_block.type==="thinking"?s.push({type:"thinking-start",data:{index:n.index,redacted:!1}}):n.content_block.type==="redacted_thinking"?s.push({type:"thinking-start",data:{index:n.index,redacted:!0}}):n.content_block.type==="server_tool_use"||n.content_block.type;break;case"content_block_delta":if(n.delta.type==="text_delta")s.push({type:"text",data:{text:n.delta.text,index:n.index}});else if(n.delta.type==="input_json_delta"){const r=t.get(n.index);r&&(r.argumentsBuffer+=n.delta.partial_json)}else n.delta.type==="thinking_delta"?s.push({type:"thinking-delta",data:{text:n.delta.thinking,index:n.index}}):n.delta.type==="signature_delta"||n.delta.type;break;case"content_block_stop":const o=t.get(n.index);if(o){try{const r=JSON.parse(o.argumentsBuffer);s.push({type:"tool-call-complete",data:{index:n.index,id:o.id,name:o.name,arguments:r}})}catch(r){throw new Error(`Failed to parse tool call arguments for ${o.name}: ${r instanceof Error?r.message:String(r)}`)}t.delete(n.index)}break;default:console.warn("Unknown Anthropic stream event type")}return s}return u(e,"handleEvent"),{handleEvent:e}}u(it,"createAnthropicStreamingAdapter");async function*ct(t){const{client:e,model:n,messages:s,system:o,tools:r,runtime:a,options:c}=t,{recorder:l}=a,i=c?{...c}:{};i.stop&&(i.stop_sequences=Array.isArray(i.stop)?i.stop:[i.stop],delete i.stop);const p={model:n,max_tokens:4096,messages:pe(s),...o&&{system:o},...r&&{tools:de(r)},...i};l?.debug?.log(p);const d=it();try{const g=await e.messages.create({...p,stream:!0});for await(const m of g){const y=d.handleEvent(m);for(const T of y)yield T}}catch(g){yield{type:"error",data:{type:"STREAMING_ERROR",message:g instanceof Error?g.message:String(g),raw:g}}}}u(ct,"createStreamingRequest$3");class lt{static{u(this,"AnthropicProvider")}name="Anthropic";client;model;constructor(e,n){this.model=n??Xe,this.client=new Fe({apiKey:e})}async createGenerationRequest(e){return await ot({client:this.client,model:this.model,...e})}createStreamingRequest(e){const{messages:n,system:s,tools:o,context:r,options:a}=e;return ct({client:this.client,model:this.model,messages:n,system:s,tools:o,runtime:r,options:a})}}const ut={GEMINI_2_5_FLASH:"gemini-2.5-flash"},pt=ut.GEMINI_2_5_FLASH;function ge(t,e,n){const s={};return e&&(s.systemInstruction=e),t&&t.length>0&&(s.tools=t.map(o=>({functionDeclarations:[{name:o.name,description:o.description,parametersJsonSchema:f.toJSONSchema(o.schema)}]}))),n&&Object.assign(s,n),s}u(ge,"prepareConfig");function me(t){return t.map(dt).filter(e=>e!==void 0)}u(me,"convertAxleMessagesToGoogleAI");function dt(t){switch(t.role){case"tool":return ft(t);case"assistant":return gt(t);case"user":return mt(t)}}u(dt,"convertMessage$3");function ft(t){return{role:"user",parts:t.content.map(e=>({functionResponse:{id:e.id??void 0,name:e.name,response:{output:e.content}}}))}}u(ft,"convertToolMessage$3");function gt(t){const e=[];if(t.content!==void 0&&t.content.length>0){const n=t.content.map(s=>s.text).join("");n&&e.push({text:n})}return t.toolCalls&&e.push(...t.toolCalls.map(n=>({functionCall:{id:n.id??void 0,name:n.name,args:n.parameters}}))),{role:"assistant",parts:e}}u(gt,"convertAssistantMessage$3");function mt(t){return typeof t.content=="string"?{role:"user",parts:[{text:t.content}]}:{role:"user",parts:t.content.map(ht).filter(n=>n!==null)}}u(mt,"convertUserMessage$3");function ht(t){return t.type==="text"||t.type==="instructions"?{text:t.type==="text"?t.text:t.instructions}:t.type==="file"&&(t.file.type==="image"||t.file.type==="document")?{inlineData:{mimeType:t.file.mimeType,data:t.file.base64}}:null}u(ht,"convertContentPart$3");function he(t){switch(t){case O.STOP:return[!0,_.Stop];case O.MAX_TOKENS:return[!0,_.Length];case O.FINISH_REASON_UNSPECIFIED:case O.SAFETY:case O.RECITATION:case O.LANGUAGE:case O.OTHER:case O.BLOCKLIST:case O.PROHIBITED_CONTENT:case O.SPII:case O.MALFORMED_FUNCTION_CALL:case O.IMAGE_SAFETY:return[!1,_.Error]}}u(he,"convertStopReason$1");async function yt(t){const{client:e,model:n,messages:s,system:o,tools:r,context:a,options:c}=t,{recorder:l}=a,i=c?{...c}:{};i.max_tokens&&(i.maxOutputTokens=i.max_tokens,delete i.max_tokens),i.stop&&(i.stopSequences=Array.isArray(i.stop)?i.stop:[i.stop],delete i.stop),i.top_p!==void 0&&(i.topP=i.top_p,delete i.top_p);const p={contents:me(s),config:ge(r,o,i)};l?.debug?.log(p);let d;try{const g=await e.models.generateContent({model:n,...p});d=_t(g,{recorder:l})}catch(g){l?.error?.log(g),d=F(g)}return l?.debug?.log(d),d}u(yt,"createGenerationRequest$1");function _t(t,e){const{recorder:n}=e,s=t.usageMetadata.promptTokenCount,o=t.usageMetadata.totalTokenCount-s,r={in:s,out:o};if(!t)return{type:"error",error:{type:"InvalidResponse",message:"Invalid or empty response from Google AI"},usage:{in:0,out:0},raw:t};if(t.promptFeedback&&t.promptFeedback.blockReason)return{type:"error",error:{type:"Blocked",message:`Response blocked by Google AI: ${t.promptFeedback.blockReason}, ${t.promptFeedback.blockReasonMessage}`},usage:r,raw:t};if(!t.candidates||t.candidates.length===0)return{type:"error",error:{type:"InvalidResponse",message:"Invalid or empty response from Google AI"},usage:{in:0,out:0},raw:t};t.candidates.length>1&&n?.warn?.log(`We received ${t.candidates.length} response candidates`);const a=t.candidates[0],l=(a.content?.parts||[]).map(d=>d.text).filter(d=>d!==void 0).join(""),[i,p]=he(a.finishReason);if(i){let d;t.functionCalls&&(d=t.functionCalls.map(m=>{if(typeof m.args!="object"||m.args===null||Array.isArray(m.args))throw new Error(`Invalid tool call arguments for ${m.name}: expected object, got ${typeof m.args}`);return{type:"tool-call",id:m.id,name:m.name,parameters:m.args}}));const g=[{type:"text",text:l}];return{type:"success",id:t.responseId,model:t.modelVersion,role:"assistant",finishReason:t.functionCalls?_.FunctionCall:p,content:g,text:M(g)??"",...d?{toolCalls:d}:{},usage:r,raw:t}}else return{type:"error",error:{type:"Undetermined",message:`Unexpected stop reason: ${p}`},usage:r,raw:t}}u(_t,"fromModelResponse$3");function wt(){let t=0,e=-1,n="",s="",o=0,r=0;function a(c){const l=[];n||(n=c.responseId||`googleai-${Date.now()}`,s=c.modelVersion||"gemini",l.push({type:"start",id:n,data:{model:s,timestamp:Date.now()}})),c.usageMetadata&&(o=c.usageMetadata.promptTokenCount||0,r=(c.usageMetadata.totalTokenCount||0)-o);const i=c.candidates?.[0];if(!i)return l;const p=i.content?.parts||[];for(const d of p){const g="thought"in d&&d.thought===!0;if(g&&d.text?(e===-1&&(e=t+1,l.push({type:"thinking-start",data:{index:e}})),l.push({type:"thinking-delta",data:{index:e,text:d.text}})):d.text&&!g&&l.push({type:"text",data:{text:d.text,index:t}}),d.functionCall){t++;const m=`tool-${t}`;l.push({type:"tool-call-start",data:{index:t,id:m,name:d.functionCall.name}}),l.push({type:"tool-call-complete",data:{index:t,id:m,name:d.functionCall.name,arguments:d.functionCall.args}})}}if(i.finishReason){const[d,g]=he(i.finishReason);d?l.push({type:"complete",data:{finishReason:g,usage:{in:o,out:r}}}):l.push({type:"error",data:{type:"FinishReasonError",message:`Unexpected finish reason: ${i.finishReason}`,usage:{in:o,out:r},raw:c}})}return l}return u(a,"handleChunk"),{handleChunk:a}}u(wt,"createGoogleAIStreamingAdapter");async function*xt(t){const{client:e,model:n,messages:s,system:o,tools:r,runtime:a,options:c}=t,{recorder:l}=a,i=c?{...c}:{};i.max_tokens&&(i.maxOutputTokens=i.max_tokens,delete i.max_tokens),i.stop&&(i.stopSequences=Array.isArray(i.stop)?i.stop:[i.stop],delete i.stop),i.top_p!==void 0&&(i.topP=i.top_p,delete i.top_p);const p={contents:me(s),config:ge(r,o,i)};l?.debug?.log(p);const d=wt();try{const g=await e.models.generateContentStream({model:n,...p});for await(const m of g){const y=d.handleChunk(m);for(const T of y)yield T}}catch(g){l?.error?.log(g),yield{type:"error",data:{type:"STREAMING_ERROR",message:g instanceof Error?g.message:String(g),raw:g}}}}u(xt,"createStreamingRequest$2");class Et{static{u(this,"GoogleAIProvider")}name="GoogleAI";client;model;constructor(e,n){this.model=n??pt,this.client=new Ue({apiKey:e})}async createGenerationRequest(e){return await yt({client:this.client,model:this.model,...e})}createStreamingRequest(e){const{messages:n,system:s,tools:o,context:r,options:a}=e;return xt({client:this.client,model:this.model,messages:n,system:s,tools:o,runtime:r,options:a})}}function ye(t){return t.map(bt).flat(1)}u(ye,"convertAxleMessagesToOllama");function _e(t){return t&&t.length>0?t.map(e=>({type:"function",function:{name:e.name,description:e.description,parameters:f.toJSONSchema(e.schema)}})):void 0}u(_e,"convertToolDefToOllama");function bt(t){switch(t.role){case"tool":return kt(t);case"assistant":return Tt(t);default:return It(t)}}u(bt,"convertMessage$2");function kt(t){return t.content.map(e=>({role:"tool",tool_call_id:e.id,content:e.content}))}u(kt,"convertToolMessage$2");function Tt(t){const e=t.toolCalls?.map(n=>{const s=n.id;return{type:"function",function:{name:n.name,arguments:n.parameters},...s&&{id:s}}});return{role:t.role,content:t.content.map(n=>n.text).join(""),...e&&{toolCalls:e}}}u(Tt,"convertAssistantMessage$2");function It(t){if(typeof t.content=="string")return{role:t.role,content:t.content};{const e=[],n=[];for(const s of t.content){const o=Rt(s);o.text!==null&&e.push(o.text),o.image!==null&&n.push(o.image)}return{role:t.role,content:e.join(""),...n.length>0&&{images:n}}}}u(It,"convertUserMessage$2");function Rt(t){return t.type==="text"||t.type==="instructions"?{text:t.type==="text"?t.text:t.instructions,image:null}:t.type==="file"&&t.file.type==="image"?{text:null,image:t.file.base64}:{text:null,image:null}}u(Rt,"convertContentPart$2");async function St(t){const{url:e,model:n,messages:s,system:o,tools:r,context:a,options:c}=t,{recorder:l}=a,i=_e(r),p=c?{...c}:{temperature:.7};p.max_tokens&&(p.num_predict=p.max_tokens,delete p.max_tokens);const d={model:n,messages:ye(s),stream:!1,options:p,...o&&{system:o},...i&&{tools:i}};l?.debug?.log(d);let g;try{const m=await fetch(`${e}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!m.ok)throw new Error(`HTTP error! status: ${m.status}`);const y=await m.json();g=Ot(y)}catch(m){l?.error?.log("Error fetching Ollama response:",m),g=F(m)}return l?.debug?.log(g),g}u(St,"createGenerationRequest");function Ot(t){if(t.done_reason==="stop"&&t.message){const e=t.message.content,n=[];if(t.message.tool_calls)for(const r of t.message.tool_calls){if(typeof r.function.arguments!="object"||r.function.arguments===null||Array.isArray(r.function.arguments))throw new Error(`Invalid tool call arguments for ${r.function.name}: expected object, got ${typeof r.function.arguments}`);n.push({type:"tool-call",id:r.id,name:r.function.name,parameters:r.function.arguments})}const s=n.length>0,o=[{type:"text",text:e}];return{type:"success",id:`ollama-${Date.now()}`,model:t.model,role:"assistant",finishReason:s?_.FunctionCall:_.Stop,content:o,text:M(o)??"",...s&&{toolCalls:n},usage:{in:t.prompt_eval_count||0,out:t.eval_count||0},raw:t}}return{type:"error",error:{type:"OllamaError",message:"Unexpected error from Ollama"},usage:{in:0,out:0},raw:t}}u(Ot,"fromModelResponse$2");function $t(){let t="",e=0,n=-1,s=0;function o(r){const a=[];if(t||(t=`ollama-${Date.now()}`,a.push({type:"start",id:t,data:{model:r.model,timestamp:Date.now()}})),r.message?.thinking&&(n===-1&&(n=e+1,a.push({type:"thinking-start",data:{index:n}})),a.push({type:"thinking-delta",data:{index:n,text:r.message.thinking}})),r.message?.content&&a.push({type:"text",data:{text:r.message.content,index:e}}),r.message?.tool_calls)for(const c of r.message.tool_calls){s++;const l=c.id||`tool-${s}`;if(typeof c.function.arguments!="object"||c.function.arguments===null||Array.isArray(c.function.arguments))throw new Error(`Invalid tool call arguments for ${c.function.name}: expected object, got ${typeof c.function.arguments}`);a.push({type:"tool-call-start",data:{index:s,id:l,name:c.function.name}}),a.push({type:"tool-call-complete",data:{index:s,id:l,name:c.function.name,arguments:c.function.arguments}})}if(r.done){const c=Pt(r.done_reason);a.push({type:"complete",data:{finishReason:c,usage:{in:r.prompt_eval_count||0,out:r.eval_count||0}}})}return a}return u(o,"handleChunk"),{handleChunk:o}}u($t,"createOllamaStreamingAdapter");function Pt(t){switch(t){case"stop":return _.Stop;case"length":return _.Length;default:return _.Stop}}u(Pt,"convertStopReason");async function*Ct(t){const{url:e,model:n,messages:s,system:o,tools:r,runtime:a,options:c}=t,{recorder:l}=a,i=_e(r),p=c?{...c}:{temperature:.7};p.max_tokens&&(p.num_predict=p.max_tokens,delete p.max_tokens);const d={model:n,messages:ye(s),stream:!0,options:p,...o&&{system:o},...i&&{tools:i}};l?.debug?.log(d);const g=$t();try{const m=await fetch(`${e}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!m.ok)throw new Error(`HTTP error! status: ${m.status}`);if(!m.body)throw new Error("Response body is null");const y=m.body.getReader(),T=new TextDecoder;let I="";for(;;){const{done:S,value:v}=await y.read();if(S)break;I+=T.decode(v,{stream:!0});const P=I.split(`
`);I=P.pop()||"";for(const A of P)if(A.trim())try{const R=JSON.parse(A),G=g.handleChunk(R);for(const C of G)yield C}catch(R){l?.error?.log("Error parsing Ollama stream chunk:",R,A)}}}catch(m){l?.error?.log("Error in Ollama streaming request:",m),yield{type:"error",data:{type:"STREAMING_ERROR",message:m instanceof Error?m.message:String(m),raw:m}}}}u(Ct,"createStreamingRequest$1");const At="http://localhost:11434";class vt{static{u(this,"OllamaProvider")}name="Ollama";url;model;recorder;constructor(e,n){this.url=n||At,this.model=e}async createGenerationRequest(e){return await St({url:this.url,model:this.model,...e})}createStreamingRequest(e){const{messages:n,system:s,tools:o,context:r,options:a}=e;return Ct({url:this.url,model:this.model,messages:n,system:s,tools:o,runtime:r,options:a})}}const h={GPT_5:"gpt-5",GPT_5_MINI:"gpt-5-mini",GPT_5_NANO:"gpt-5-nano",GPT_5_CHAT_LATEST:"gpt-5-chat-latest",GPT_5_PRO:"gpt-5-pro",GPT_5_CODEX:"gpt-5-codex",GPT_4_1:"gpt-4.1",GPT_4_1_2025_04_14:"gpt-4.1-2025-04-14",GPT_4_1_MINI:"gpt-4.1-mini",GPT_4_1_MINI_2025_04_14:"gpt-4.1-mini-2025-04-14",GPT_4_1_NANO:"gpt-4.1-nano",GPT_4_1_NANO_2025_04_14:"gpt-4.1-nano-2025-04-14",GPT_4O:"gpt-4o",GPT_4O_2024_05_13:"gpt-4o-2024-05-13",GPT_4O_2024_08_06:"gpt-4o-2024-08-06",GPT_4O_2024_11_20:"gpt-4o-2024-11-20",GPT_4O_MINI:"gpt-4o-mini",GPT_4O_MINI_2024_07_18:"gpt-4o-mini-2024-07-18",GPT_4O_AUDIO_PREVIEW:"gpt-4o-audio-preview",GPT_4O_AUDIO_PREVIEW_2024_10_01:"gpt-4o-audio-preview-2024-10-01",GPT_4O_AUDIO_PREVIEW_2024_12_17:"gpt-4o-audio-preview-2024-12-17",GPT_4O_AUDIO_PREVIEW_2025_06_03:"gpt-4o-audio-preview-2025-06-03",GPT_4O_MINI_AUDIO_PREVIEW:"gpt-4o-mini-audio-preview",GPT_4O_MINI_AUDIO_PREVIEW_2024_12_17:"gpt-4o-mini-audio-preview-2024-12-17",GPT_REALTIME:"gpt-realtime",GPT_REALTIME_MINI:"gpt-realtime-mini",GPT_4O_REALTIME_PREVIEW:"gpt-4o-realtime-preview",GPT_4O_REALTIME_PREVIEW_2024_10_01:"gpt-4o-realtime-preview-2024-10-01",GPT_4O_REALTIME_PREVIEW_2024_12_17:"gpt-4o-realtime-preview-2024-12-17",GPT_4O_REALTIME_PREVIEW_2025_06_03:"gpt-4o-realtime-preview-2025-06-03",GPT_4O_MINI_REALTIME_PREVIEW:"gpt-4o-mini-realtime-preview",GPT_4O_MINI_REALTIME_PREVIEW_2024_12_17:"gpt-4o-mini-realtime-preview-2024-12-17",GPT_4O_SEARCH_PREVIEW:"gpt-4o-search-preview",GPT_4O_SEARCH_PREVIEW_2025_03_11:"gpt-4o-search-preview-2025-03-11",GPT_4O_MINI_SEARCH_PREVIEW:"gpt-4o-mini-search-preview",GPT_4O_MINI_SEARCH_PREVIEW_2025_03_11:"gpt-4o-mini-search-preview-2025-03-11",GPT_4O_TRANSCRIBE:"gpt-4o-transcribe",GPT_4O_MINI_TRANSCRIBE:"gpt-4o-mini-transcribe",O4_MINI:"o4-mini",O4_MINI_2025_04_16:"o4-mini-2025-04-16",O3:"o3",O3_PRO:"o3-pro",O3_MINI:"o3-mini",O3_MINI_2025_01_31:"o3-mini-2025-01-31"},we=[h.GPT_5,h.GPT_5_MINI,h.GPT_5_NANO,h.GPT_5_CHAT_LATEST,h.GPT_5_PRO,h.GPT_5_CODEX,h.GPT_4_1,h.GPT_4_1_2025_04_14,h.GPT_4_1_MINI,h.GPT_4_1_MINI_2025_04_14,h.GPT_4_1_NANO,h.GPT_4_1_NANO_2025_04_14,h.GPT_4O,h.GPT_4O_2024_05_13,h.GPT_4O_2024_08_06,h.GPT_4O_2024_11_20,h.GPT_4O_MINI,h.GPT_4O_MINI_2024_07_18,h.GPT_4O_AUDIO_PREVIEW,h.GPT_4O_AUDIO_PREVIEW_2024_10_01,h.GPT_4O_AUDIO_PREVIEW_2024_12_17,h.GPT_4O_AUDIO_PREVIEW_2025_06_03,h.GPT_4O_MINI_AUDIO_PREVIEW,h.GPT_4O_MINI_AUDIO_PREVIEW_2024_12_17,h.GPT_REALTIME,h.GPT_REALTIME_MINI,h.GPT_4O_REALTIME_PREVIEW,h.GPT_4O_REALTIME_PREVIEW_2024_10_01,h.GPT_4O_REALTIME_PREVIEW_2024_12_17,h.GPT_4O_REALTIME_PREVIEW_2025_06_03,h.GPT_4O_MINI_REALTIME_PREVIEW,h.GPT_4O_MINI_REALTIME_PREVIEW_2024_12_17,h.GPT_4O_SEARCH_PREVIEW,h.GPT_4O_SEARCH_PREVIEW_2025_03_11,h.GPT_4O_MINI_SEARCH_PREVIEW,h.GPT_4O_MINI_SEARCH_PREVIEW_2025_03_11,h.GPT_4O_TRANSCRIBE,h.GPT_4O_MINI_TRANSCRIBE,h.O4_MINI,h.O4_MINI_2025_04_16,h.O3,h.O3_PRO,h.O3_MINI,h.O3_MINI_2025_01_31],Mt=h.GPT_5;function xe(t){if(t&&t.length>0)return t.map(e=>{const n=f.toJSONSchema(e.schema);return{type:"function",function:{name:e.name,description:e.description,parameters:n}}})}u(xe,"toModelTools");function Ee(t,e){const n=t.map(jt).flat(1);return e?[{role:"system",content:e},...n]:n}u(Ee,"convertAxleMessagesToChatCompletion");function jt(t){switch(t.role){case"tool":return Nt(t);case"assistant":return Gt(t);default:return Dt(t)}}u(jt,"convertMessage$1");function Nt(t){return t.content.map(e=>({role:"tool",tool_call_id:e.id,content:e.content}))}u(Nt,"convertToolMessage$1");function Gt(t){const e=t.toolCalls?.map(n=>{const s=n.id;return{type:"function",function:{name:n.name,arguments:JSON.stringify(n.parameters)},...s&&{id:s}}});return{role:t.role,content:t.content.map(n=>n.text).join(""),...e&&{toolCalls:e}}}u(Gt,"convertAssistantMessage$1");function Dt(t){if(typeof t.content=="string")return{role:t.role,content:t.content};{const e=t.content.map(Ft).filter(n=>n!==null);return{role:t.role,content:e}}}u(Dt,"convertUserMessage$1");function Ft(t){if(t.type==="text"||t.type==="instructions")return{type:"text",text:t.type==="text"?t.text:t.instructions};if(t.type==="file"){if(t.file.type==="image")return{type:"image_url",image_url:{url:`data:${t.file.mimeType};base64,${t.file.base64}`}};if(t.file.type==="document")return{type:"file",file:{filename:t.file.name,file_data:`data:${t.file.mimeType};base64,${t.file.base64}`}}}return null}u(Ft,"convertContentPart$1");async function Ut(t){const{client:e,model:n,messages:s,system:o,tools:r,context:a,options:c}=t,{recorder:l}=a;let i=xe(r);const p={model:n,messages:Ee(s,o),...i&&{tools:i},...c};l?.debug?.log(p);let d;try{const g=await e.chat.completions.create(p);d=Wt(g)}catch(g){l?.error?.log(g),d=F(g)}return l?.debug?.log(d),d}u(Ut,"createGenerationRequestWithChatCompletion");function Wt(t){if(t.choices.length>0){const e=t.choices[0],n=e.message.tool_calls?.filter(o=>o.type==="function")?.map(o=>{try{return{type:"tool-call",id:o.id,name:o.function.name,parameters:JSON.parse(o.function.arguments)}}catch(r){throw new Error(`Failed to parse tool call arguments for ${o.function.name}: ${r instanceof Error?r.message:String(r)}`)}}),s=[];return e.message.content&&s.push({type:"text",text:e.message.content}),{type:"success",id:t.id,model:t.model,role:e.message.role,finishReason:ee(e.finish_reason),content:s,text:M(s)??"",toolCalls:n,usage:{in:t.usage?.prompt_tokens??0,out:t.usage?.completion_tokens??0},raw:t}}return{type:"error",error:{type:"undetermined",message:"Unexpected response from OpenAI"},usage:{in:t.usage?.prompt_tokens??0,out:t.usage?.completion_tokens??0},raw:t}}u(Wt,"fromModelResponse$1");function Lt(){const t=new Map;let e=0,n="",s="";function o(r){const a=[],c=r.choices[0];if(!c)return a;n||(n=r.id,s=r.model,a.push({type:"start",id:n,data:{model:s,timestamp:Date.now()}}));const l=c.delta;if(l.content&&a.push({type:"text",data:{text:l.content,index:e}}),l.tool_calls)for(const i of l.tool_calls){const p=i.index;if(!t.has(p)){const g=e+p+1,m=i.id||`tool-${g}`;t.set(p,{id:m,name:i.function?.name||"",argumentsBuffer:""}),a.push({type:"tool-call-start",data:{index:g,id:m,name:i.function?.name||""}})}const d=t.get(p);i.id&&(d.id=i.id),i.function?.name&&(d.name=i.function.name),i.function?.arguments&&(d.argumentsBuffer+=i.function.arguments)}if(c.finish_reason){for(const[p,d]of t){const g=e+p+1;try{const m=JSON.parse(d.argumentsBuffer);a.push({type:"tool-call-complete",data:{index:g,id:d.id,name:d.name,arguments:m}})}catch(m){throw new Error(`Failed to parse tool call arguments for ${d.name}: ${m instanceof Error?m.message:String(m)}`)}}const i=qt(c.finish_reason);a.push({type:"complete",data:{finishReason:i,usage:r.usage?{in:r.usage.prompt_tokens,out:r.usage.completion_tokens}:{in:0,out:0}}})}return a}return u(o,"handleChunk"),{handleChunk:o}}u(Lt,"createChatCompletionStreamingAdapter");function qt(t){switch(t){case"stop":return _.Stop;case"length":return _.Length;case"tool_calls":case"function_call":return _.FunctionCall;case"content_filter":return _.Error;default:return _.Stop}}u(qt,"convertFinishReason");function Bt(){let t="",e="",n=0,s=0,o=0;const r=new Map,a=new Set;function c(l){const i=[];switch(l.type){case"response.created":{t=l.response.id||`openai-${Date.now()}`,e=l.response.model,i.push({type:"start",id:t,data:{model:e,timestamp:Date.now()}});break}case"response.output_text.delta":{i.push({type:"text",data:{text:l.delta,index:n}});break}case"response.function_call_arguments.delta":{const p=l.item_id;r.has(p)||(s++,r.set(p,{id:p,name:"",argumentsBuffer:""}),i.push({type:"tool-call-start",data:{index:s,id:p,name:""}}));const d=r.get(p);d.argumentsBuffer+=l.delta;break}case"response.function_call_arguments.done":{const p=l.item_id;if(r.get(p)){try{const g=JSON.parse(l.arguments);i.push({type:"tool-call-complete",data:{index:s,id:p,name:l.name,arguments:g}})}catch(g){throw new Error(`Failed to parse function call arguments for ${l.name}: ${g instanceof Error?g.message:String(g)}`)}r.delete(p)}break}case"response.completed":{const p=l.response.usage;i.push({type:"complete",data:{finishReason:l.response.incomplete_details?_.Error:_.Stop,usage:{in:p?.input_tokens||0,out:p?.output_tokens||0}}});break}case"response.failed":{i.push({type:"error",data:{type:"RESPONSES_API_ERROR",message:`Response failed: ${l.response.status}`,raw:l}});break}case"response.output_item.added":{if(l.item?.type==="reasoning"){const p=l.item.id;a.add(p),o++,i.push({type:"thinking-start",data:{index:o}})}break}case"response.reasoning_text.delta":{l.delta&&i.push({type:"thinking-delta",data:{index:o,text:l.delta}});break}case"response.reasoning_summary_text.delta":{l.delta&&i.push({type:"thinking-delta",data:{index:o,text:l.delta}});break}case"response.output_item.done":{if(l.item?.type==="reasoning"){const p=l.item.id;a.delete(p)}break}}return i}return u(c,"handleEvent"),{handleEvent:c}}u(Bt,"createResponsesAPIStreamingAdapter");function be(t){if(t&&t.length>0)return t.map(e=>{const n=f.toJSONSchema(e.schema);return{type:"function",strict:!0,name:e.name,description:e.description,parameters:n}})}u(be,"prepareTools");function ke(t){return t.map(Jt).flat(1)}u(ke,"convertAxleMessageToResponseInput");function Jt(t){switch(t.role){case"tool":return Ht(t);case"assistant":return Vt(t);default:return Zt(t)}}u(Jt,"convertMessage");function Ht(t){return t.content.map(e=>({type:"function_call_output",call_id:e.id,output:e.content}))}u(Ht,"convertToolMessage");function Vt(t){const e=[],n=t.content.filter(r=>r.type==="thinking");if(n.length>0)for(const r of n)e.push({type:"reasoning",id:`reasoning_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,summary:[{type:"summary_text",text:r.text}]});const s=M(t.content),o=t.toolCalls?.map(r=>{const a=r.id;return{type:"function",function:{name:r.name,arguments:JSON.stringify(r.parameters)},...a&&{id:a}}});return(s||o)&&e.push({role:t.role,content:s,...o&&{toolCalls:o}}),e}u(Vt,"convertAssistantMessage");function Zt(t){if(typeof t.content=="string")return{role:t.role,content:t.content};{const e=t.content.map(zt).filter(n=>n!==null);return{role:t.role,content:e}}}u(Zt,"convertUserMessage");function zt(t){if(t.type==="text")return{type:"input_text",text:t.text};if(t.type==="file"){if(t.file.type==="image")return{type:"input_image",image_url:`data:${t.file.mimeType};base64,${t.file.base64}`,detail:"auto"};if(t.file.type==="document")return{type:"input_file",filename:t.file.path,file_data:`data:${t.file.mimeType};base64,${t.file.base64}`}}return t.type==="thinking",null}u(zt,"convertContentPart");async function*Kt(t){const{client:e,model:n,messages:s,system:o,tools:r,runtime:a,options:c}=t,{recorder:l}=a;we.includes(n)?yield*Yt({client:e,model:n,messages:s,system:o,tools:r,runtime:a,options:c}):yield*Xt({client:e,model:n,messages:s,system:o,tools:r,runtime:a,options:c})}u(Kt,"createStreamingRequest");async function*Xt(t){const{client:e,model:n,messages:s,system:o,tools:r,runtime:a,options:c}=t,{recorder:l}=a,i=xe(r),p={model:n,messages:Ee(s,o),...i&&{tools:i},...c,stream:!0};l?.debug?.log(p);const d=Lt();try{const g=await e.chat.completions.create(p);for await(const m of g){const y=d.handleChunk(m);for(const T of y)yield T}}catch(g){l?.error?.log(g),yield{type:"error",data:{type:"STREAMING_ERROR",message:g instanceof Error?g.message:String(g),raw:g}}}}u(Xt,"createChatCompletionStream");async function*Yt(t){const{client:e,model:n,messages:s,system:o,tools:r,runtime:a,options:c}=t,{recorder:l}=a;console.log(c);const i=be(r),p={model:n,input:ke(s),...o&&{instructions:o},stream:!0,...i?{tools:i}:{},...c};l?.debug?.log(p);const d=Bt();try{const g=e.responses.stream(p);for await(const m of g){const y=d.handleEvent(m);for(const T of y)yield T}}catch(g){l?.error?.log(g),yield{type:"error",data:{type:"STREAMING_ERROR",message:g instanceof Error?g.message:String(g),raw:g}}}}u(Yt,"createResponsesAPIStream");async function Qt(t){const{client:e,model:n,messages:s,system:o,tools:r,context:a,options:c}=t,{recorder:l}=a,i=be(r),p={model:n,input:ke(s),...o&&{instructions:o},...i?{tools:i}:{},...c};l?.debug?.log(p);let d;try{const g=await e.responses.create(p);d=en(g)}catch(g){l?.error?.log(g),d=F(g)}return l?.debug?.log(d),d}u(Qt,"createGenerationRequestWithResponsesAPI");function en(t){if(t.error)return{type:"error",error:{type:t.error.code||"undetermined",message:t.error.message||"Response generation failed"},usage:{in:t.usage?.input_tokens??0,out:t.usage?.output_tokens??0},raw:t};const e=t.output?.filter(o=>o.type==="function_call")?.map(o=>{try{return{type:"tool-call",id:o.id||"",name:o.name||"",parameters:o.arguments?JSON.parse(o.arguments):{}}}catch(r){throw new Error(`Failed to parse tool call arguments for ${o.name}: ${r instanceof Error?r.message:String(r)}`)}}),n=t.output?.filter(o=>o.type==="reasoning")?.map(o=>o),s=[];if(n&&n.length>0)for(const o of n){const r=o.summary?.[0]?.text||o.content?.[0]?.text||"";(r||o.encrypted_content)&&s.push({type:"thinking",text:r,...o.encrypted_content&&{encrypted:o.encrypted_content}})}return t.output_text&&s.push({type:"text",text:t.output_text}),{type:"success",id:t.id,model:t.model||"",role:"assistant",finishReason:t.incomplete_details?_.Error:_.Stop,content:s,text:M(s)??"",...e?.length&&{toolCalls:e},usage:{in:t.usage?.input_tokens??0,out:t.usage?.output_tokens??0},raw:t}}u(en,"fromModelResponse");class tn{static{u(this,"OpenAIProvider")}name="OpenAI";client;model;constructor(e,n){this.model=n||Mt,this.client=new We({apiKey:e})}async createGenerationRequest(e){return we.includes(this.model)?await Qt({client:this.client,model:this.model,...e}):await Ut({client:this.client,model:this.model,...e})}createStreamingRequest(e){const{messages:n,system:s,tools:o,context:r,options:a}=e;return Kt({client:this.client,model:this.model,messages:n,system:s,tools:o,runtime:r,options:a})}}async function Te(t){const{provider:e,messages:n,system:s,tools:o,recorder:r,options:a}=t;return e.createGenerationRequest({messages:n,system:s,tools:o,context:{recorder:r},options:a})}u(Te,"generate");function nn(t,e){if(!e||Object.keys(e).length===0)throw new k(`The provider ${t} is not configured. Please check your configuration.`);switch(t){case"openai":return new tn(e["api-key"],e.model);case"anthropic":return new lt(e["api-key"],e.model);case"googleai":return new Et(e["api-key"],e.model);case"ollama":{const n=e;return new vt(n.model,n.url)}default:throw new k("The provider is unsupported")}}u(nn,"getProvider");class oe extends k{static{u(this,"TaskError")}constructor(e,n){super(e,{code:"TASK_ERROR",id:n?.id,details:{taskType:n?.taskType,taskIndex:n?.taskIndex,...n?.details},cause:n?.cause}),Object.setPrototypeOf(this,oe.prototype)}}const w={Running:"running",Success:"success",PartialSuccess:"partialSuccess",Fail:"fail"};var b=(t=>(t[t.Trace=10]="Trace",t[t.Debug=20]="Debug",t[t.Info=30]="Info",t[t.Warn=40]="Warn",t[t.Error=50]="Error",t[t.Fatal=60]="Fatal",t))(b||{});class sn{static{u(this,"Recorder")}instanceId=crypto.randomUUID();currentLevel=b.Info;logs=[];writers=[];_debug;_info;_warn;_error;constructor(){this.buildMethods()}buildMethods(){this._debug=b.Debug>=this.currentLevel?this.createLoggingFunction(b.Debug):null,this._info=b.Info>=this.currentLevel?this.createLoggingFunction(b.Info):null,this._warn=b.Warn>=this.currentLevel?this.createLoggingFunction(b.Warn):null,this._error=this.createLoggingFunction(b.Error)}set level(e){this.currentLevel=e,this.buildMethods()}get level(){return this.currentLevel}get info(){return this._info}get warn(){return this._warn}get error(){return this._error}get debug(){return this._debug}subscribe(e){this.writers.includes(e)||this.writers.push(e)}unsubscribe(e){const n=this.writers.indexOf(e);n!==-1&&this.writers.splice(n,1)}publish(e){this.logs.push(e);for(const n of this.writers)n.handleEvent(e)}logFunction(e,n,...s){let o=s.map(r=>typeof r=="string"?{message:r}:r instanceof Error?Le(r):r);this.publish({level:e,time:Date.now(),kind:n,payload:o})}createLoggingFunction(e){return{log:this.logFunction.bind(this,e,"body"),heading:{log:this.logFunction.bind(this,e,"heading")}}}getLogs(e=b.Info){return this.logs.filter(n=>n.level>=e)}async shutdown(){for(const e of this.writers)typeof e.flush=="function"&&await e.flush()}}async function rn(t,e){const{defaults:n,tag:s}=e;let o=null,r="";if(t)try{r=Q(t),o=await D(r,{encoding:"utf-8"})}catch{throw new Error(`${s} not found, see --help for details`)}else{for(const a of n.formats)try{r=Q(n.name+"."+a),o=await D(r,{encoding:"utf-8"});break}catch{continue}if(o===null)throw new Error(`${s} not found, see --help for details`)}return{content:o,format:r.split(".").pop()??""}}u(rn,"searchAndLoadFile");async function on(t,e){let n="";for(const s of t){const o=await ie(s);e?.debug?.log(`many-files parser. For glob "${s}", found ${o.length} files.`);const r=await Promise.all(o.map(async a=>{const c=await D(a,"utf-8");return a+`:
`+c}));n+=r.join(`
`)}return n}u(on,"loadManyFiles");function an(t,e){t=t.replace("**/*","**");const n=/(?<asterisks>\*{1,2})(?<extension>\.[^\\/]+)?/,s=t.match(n);if(s){let o="";return s.groups?.asterisks.length==1?o+=e.stem:o+=e.dir+e.stem,s.groups?.extension?o+=s.groups.extension:o+=e.ext,t.replace(s[0],o)}return t}u(an,"replaceFilePattern");function cn(t){const e=/(?<name>[^\\/]+)(?<extension>\.[^\\/]+)$/,n=t.match(e);return n&&n.length>0&&n.groups?{abs:t,dir:t.replace(n[0],""),ext:n.groups.extension,stem:n.groups.name,name:n[0]}:null}u(cn,"pathToComponents");async function Ie(t){const e=ze(t);try{await ce(e)}catch{await Ze(e),await Ie(e)}}u(Ie,"ensureDirectoryExistence");async function ln({filePath:t,content:e}){await Ie(t),await Ve(t,e)}u(ln,"writeFileWithDirectories");const q=[".jpg",".jpeg",".png",".gif",".webp",".bmp",".tiff"],B=[".pdf"],J=[".txt",".md",".markdown"],Re=20*1024*1024;function un(t){return t.type==="text"}u(un,"isTextFileInfo");function pn(t){return t.type==="image"||t.type==="document"}u(pn,"isBase64FileInfo");function dn(t){const e=le(t).toLowerCase();if(J.includes(e))return"utf-8";if(q.includes(e)||B.includes(e))return"base64";{const n=[...J,...q,...B];throw new Error(`Unsupported file type: ${e}. Supported types: ${n.join(", ")}`)}}u(dn,"getEncodingForFile");async function H(t,e){const n=Q(t);try{await ce(n)}catch{throw new Error(`File not found: ${t}`)}const s=await He(n);if(s.size>Re)throw new Error(`File too large: ${s.size} bytes. Maximum allowed: ${Re} bytes`);const o=le(n).toLowerCase(),r=n.split("/").pop()||"";if((e||dn(n))==="utf-8"){if(!J.includes(o))throw new Error(`Unsupported text file type: ${o}. Supported types: ${J.join(", ")}`);let c;switch(o){case".txt":c="text/plain";break;case".md":case".markdown":c="text/markdown";break;default:c="text/plain"}const l=await D(n,"utf-8");return{path:n,content:l,mimeType:c,size:s.size,name:r,type:"text"}}else{let c,l;if(q.includes(o))switch(c="image",o){case".jpg":case".jpeg":l="image/jpeg";break;case".png":l="image/png";break;case".gif":l="image/gif";break;case".webp":l="image/webp";break;case".bmp":l="image/bmp";break;case".tiff":l="image/tiff";break;default:l="image/jpeg"}else if(B.includes(o))c="document",l="application/pdf";else throw new Error(`Unsupported file type: ${o}. Supported types: ${[...q,...B].join(", ")}`);const p=(await D(n)).toString("base64");return{path:n,base64:p,mimeType:l,size:s.size,name:r,type:c}}}u(H,"loadFileContent");const fn=f.object({engine:f.literal("ollama"),url:f.string().optional(),model:f.string().optional()}),gn=f.object({engine:f.literal("anthropic"),"api-key":f.string().optional(),model:f.string().optional()}),mn=f.object({engine:f.literal("openai"),"api-key":f.string().optional(),model:f.string().optional()}),hn=f.object({engine:f.literal("googleai"),"api-key":f.string().optional(),model:f.string().optional()}),yn=f.union([fn,gn,mn,hn]),_n=f.object({file:f.string()}),wn=f.object({file:f.string()}),xn=f.object({file:f.string()}),En=f.object({source:f.literal("file"),pattern:f.string(),files:f.union([f.string(),f.array(f.string())])}),bn=f.enum(["string","string[]","number","boolean"]),kn=f.object({uses:f.literal("chat"),system:f.string().optional(),message:f.string(),output:f.record(f.string(),bn).optional(),replace:f.array(En).optional(),tools:f.array(f.string()).optional(),images:f.array(_n).optional(),documents:f.array(wn).optional(),references:f.array(xn).optional()}),Tn=f.object({uses:f.literal("write-to-disk"),output:f.string(),keys:f.union([f.string(),f.array(f.string())]).optional()}),Se=f.union([kn,Tn]),In=f.object({type:f.literal("file-exist"),pattern:f.string()}),Rn=f.object({type:f.literal("files"),source:f.string(),bind:f.string(),"skip-if":f.array(In).optional()}),Sn=f.object({tools:f.array(f.string()).optional(),steps:f.array(Se)}).strict(),On=f.object({tools:f.array(f.string()).optional(),batch:f.array(Rn),steps:f.array(Se)}).strict(),$n=f.union([On,Sn]),Pn=$n.and(f.object({dependsOn:f.union([f.string(),f.array(f.string())]).optional()})),Oe=f.record(f.string(),Pn),Cn=f.object({using:yn,jobs:Oe}),An=f.object({"api-key":f.string(),rateLimit:f.number().optional()}),vn=f.object({url:f.string().optional(),model:f.string().optional()}),Mn=f.object({"api-key":f.string(),model:f.string().optional()}),jn=f.object({"api-key":f.string(),model:f.string().optional()}),Nn=f.object({"api-key":f.string(),model:f.string().optional()}),Gn=f.object({openai:jn.optional(),anthropic:Mn.optional(),ollama:vn.optional(),googleai:Nn.optional(),brave:An.optional()});class Dn{static{u(this,"FileRunPlanner")}constructor(e,n,s=[]){this.source=e,this.bind=n,this.skipConditions=s}async plan(e){const n=[],s=await ie(this.source,{withFileTypes:!0});for(const o of s){const r=o.fullpath(),a=cn(r);let c=!1;for(const l of this.skipConditions)if(c=await l.eval({components:a}),c)break;if(!c){const l=await qe(r,"utf-8"),i={variables:{[this.bind]:l,...a},tasks:e};n.push(i)}}return n}}class Fn{static{u(this,"MultiPlanner")}planners;constructor(e){this.planners=e}async plan(e){const n=this.planners.map(async o=>await o.plan(e));return(await Promise.all(n)).flat()}}function te(t,e,n="{{}}"){const s=n==="{{}}"?/\{\{(.*?)\}\}/g:/\{(.*?)\}/g;return t=t.replace(s,(o,r)=>{if(r=r.trim(),Object.prototype.hasOwnProperty.call(e,r)){const a=e[r];return a==null?"":String(a)}return o}),t}u(te,"replaceVariables");class Un{static{u(this,"FileExistSkipCondition")}constructor(e){this.pattern=e}type="file-exist";async eval(e){const n=te(this.pattern,e.components,"{}");try{return await Be(n,Je.F_OK),!0}catch{return!1}}}function V(t,e=0){const n={};for(const[s,o]of Object.entries(t))if(typeof o=="string")switch(o){case"string":n[s]=e===0?x.string():x.string().optional();break;case"number":n[s]=e===0?x.number():x.number().optional();break;case"boolean":n[s]=e===0?x.boolean():x.boolean().optional();break;case"string[]":n[s]=x.array(x.string());break;default:throw new Error(`Unsupported declarative type: ${o}`)}else if(Array.isArray(o))if(o.length===1&&typeof o[0]=="object"){const r=V(o[0],e+1);n[s]=x.array(x.object(r))}else throw new Error(`Unsupported array format for key ${s}. Expected [DeclarativeSchema].`);else n[s]=x.object(V(o,e+1));return n}u(V,"declarativeToOutputSchema");function Z(t){if(t instanceof x.ZodString)return["string","Your answer"];if(t instanceof x.ZodNumber)return["number",42];if(t instanceof x.ZodBoolean)return["boolean",!0];if(t instanceof x.ZodArray){const e=t.element;if(e instanceof x.ZodString)return["string array",["answer 1","answer 2","third answer"]];if(e instanceof x.ZodNumber)return["number array",[42,59,3.14]];if(e instanceof x.ZodBoolean)return["boolean array",[!0,!1,!1]];if(e instanceof x.ZodObject){const[n,s]=Z(e);return["object array",[s,s]]}return["array",[]]}if(t instanceof x.ZodObject){const e=t.shape,n={};for(const[s,o]of Object.entries(e)){const[r,a]=Z(o);n[s]=a}return["JSON object",n]}if(t instanceof x.ZodOptional){const e=t.unwrap(),[n,s]=Z(e);return[`${n} | undefined`,s]}}u(Z,"zodToExample");function $e(t){return typeof t=="object"&&Object.values(t).every(e=>e&&typeof e=="object"&&"_def"in e)}u($e,"isOutputSchema");class Pe{static{u(this,"AbstractInstruct")}type="instruct";prompt;system=null;inputs={};tools={};files=[];textReferences=[];instructions=[];schema;rawResponse;_taggedSections=void 0;_result=void 0;constructor(e,n){this.prompt=e,this.schema=n}setInputs(e){this.inputs=e}addInput(e,n){this.inputs[e]=n}addTools(e){for(const n of e)this.tools[n.name]=n}addTool(e){this.tools[e.name]=e}addImage(e){if(e.type!=="image")throw new Error(`Expected image file, got ${e.type}`);const n=e;this.files.push(n)}addDocument(e){if(e.type!=="document")throw new Error(`Expected document file, got ${e.type}`);const n=e;this.files.push(n)}addFile(e){if(!pn(e))throw new Error(`Expected image or document file, got ${e.type}`);this.files.push(e)}addReference(e,n){if(typeof e=="string"){this.textReferences.push({content:e,name:n?.name});return}if(un(e))this.textReferences.push({content:e.content,name:n?.name??e.name});else throw new Error(`Expected text file, got ${e.type}`)}addInstructions(e){if(typeof e!="string"||e.trim()==="")throw new Error("Instruction must be a non-empty string");this.instructions.push(e)}hasTools(){return Object.keys(this.tools).length>0}hasFiles(){return this.files.length>0}get result(){return this._result}compile(e,n={}){const s=this.createUserMessage(e,n),o=this.createInstructions();return{message:s,instructions:o}}createUserMessage(e,n={}){const{recorder:s,options:o}=n,r={...e,...this.inputs};let a=te(this.prompt,r);if(this.textReferences.length>0)for(const[c,l]of this.textReferences.entries()){const i=l.name?`: ${l.name}`:"";a+=`

## Reference ${c+1}${i}

\`\`\`${l.content}'''`}if(o?.warnUnused){const c=a.match(/\{\{(.*?)\}\}/g);if(c)throw s?.error.log(`Warning unused variables ${c.join(", ")}`),new Error(`Unused variables: ${c.join(", ")}`)}return a}createInstructions(e=""){if(e=`# Instructions

`+e,Object.keys(this.schema).length>0){e+=`## Output Format Instructions
`,e+=`
Here is how you should format your output. Follow the instructions strictly.
`;for(const[s,o]of Object.entries(this.schema)){const r=this.generateFieldInstructions(s,o);e+=r}}if(this.instructions.length>0){e+=`
## Additional Instructions

`;for(const s of this.instructions)e+=`- ${s}
`}return e}generateFieldInstructions(e,n){const[s,o]=Z(n);return`
- Use <${e}></${e}> tags to indicate the answer for ${e}. The answer must be a ${s}.
  Example: <${e}>${JSON.stringify(o)}</${e}>
`}finalize(e,n={}){const{recorder:s}=n;if(this.rawResponse=e,Object.keys(this.schema).length===0){if(e.trim()==="{}"||e.trim()==="")return this._result={},this._result;throw new Error("Schema is empty, but rawValue is not an empty object representation or empty string.")}this._taggedSections=this._taggedSections||this.parseTaggedSections(e);const r={};for(const[a,c]of Object.entries(this.schema)){const l=this._taggedSections.tags[a];if(l!==void 0)r[a]=this.preprocessValue(c,l);else if(c._def.typeName!=="ZodOptional")throw new Error(`Expected results with tag ${a} but it does not exist`)}try{const a={};for(const[c,l]of Object.entries(this.schema))c in r&&(a[c]=l.parse(r[c]));return this._result=a,this._result}catch(a){if(a&&typeof a=="object"&&"issues"in a){const c=a.issues.map(l=>`${l.path.join(".")}: ${l.message}`).join(", ");throw new Error(`Validation failed: ${c}`)}throw a}}preprocessValue(e,n){switch(n=n.trim(),e._def.typeName){case"ZodString":try{return JSON.parse(n)}catch{if(typeof n=="string")return n;throw new Error(`Cannot parse '${n}' as string. Ensure it is a valid JSON string or a plain string.`)}case"ZodNumber":{const s=parseFloat(n);if(isNaN(s))throw new Error(`Cannot parse '${n}' as number`);return s}case"ZodBoolean":{const s=n.toLowerCase();if(s==="true")return!0;if(s==="false")return!1;throw new Error(`Cannot parse '${n}' as boolean. Expected 'true' or 'false'`)}case"ZodArray":{if(n==="")return[];try{const s=JSON.parse(n);if(Array.isArray(s))return s}catch{}if(n.includes(","))return n.split(",").map(s=>{const o=s.trim();try{return JSON.parse(o)}catch{return o}}).filter(s=>s!=="")}case"ZodObject":{n.includes("```json")&&(n=n.replace(/```json/g,"").replace(/```/g,""));try{return JSON.parse(n)}catch(s){throw new Error(`Cannot parse object as JSON: ${s.message}`)}}case"ZodOptional":{const s=e._def.innerType;return this.preprocessValue(s,n)}default:return n}}parseTaggedSections(e){e.trim().startsWith("```json")&&e.trim().endsWith("```")&&(e=e.trim().slice(7,-3).trim());const n=/<(\w+)>(.*?)<\/\1>/gs,s={};let o=e;o=o.replace(n,(a,c,l)=>(s[c]=l,""));const r=/<(\w+)>(.*?)(?:<\/?\w+>|$)/gs;return o=o.replace(r,(a,c,l)=>(s[c]=l,"")),{tags:s,remaining:o.trim()}}}class j extends Pe{static{u(this,"Instruct")}constructor(e,n){super(e,n)}static with(e,n){if(!n)return new j(e,{response:x.string()});if($e(n))return new j(e,n);{const s=V(n);return new j(e,s)}}}function U(t){return Array.isArray(t)?t:[t]}u(U,"arrayify");function $(t,e){return e?`${e}:${t.slice(0,8)}`:t.slice(0,8)}u($,"friendly");function Wn(t){return new Promise(e=>setTimeout(e,t))}u(Wn,"delay");const Ln=x.object({searchTerm:x.string().describe("The search term to query")});class qn{static{u(this,"BraveSearchTool")}name="brave";description="Perform a search using the Brave search engine";schema=Ln;apiKey;throttle;lastExecTime=0;constructor(e){e&&this.setConfig(e)}setConfig(e){const{rateLimit:n}=e;this.apiKey=e["api-key"],this.throttle=n?1100/n:void 0}async execute(e){const{searchTerm:n}=e;if(this.throttle){for(;Date.now()-this.lastExecTime<this.throttle;)await Wn(this.throttle-(Date.now()-this.lastExecTime));this.lastExecTime=Date.now()}try{const s=this.apiKey,o="https://api.search.brave.com/res/v1/web/search",r=new URL(o);r.searchParams.append("q",n),r.searchParams.append("format","json");const a=await fetch(r.toString(),{method:"GET",headers:{Accept:"application/json","X-Subscription-Token":s}});if(!a.ok)throw new Error(`[Brave] HTTP error ${a.status}: ${a.statusText}`);const c=await a.json();return JSON.stringify(c)}catch(s){throw s instanceof Error?new Error(`[Brave] Error fetching search results: ${s.message}`):s}}}const Bn=new qn,Jn=L.object({operation:L.enum(["add","subtract","multiply","divide"]).describe("The operation to perform (add, subtract, multiply, divide)"),a:L.number().describe("First operand"),b:L.number().describe("Second operand")}),Hn={name:"calculator",description:"Performs basic arithmetic operations",schema:Jn,execute:u(async({operation:t,a:e,b:n})=>{switch(t){case"add":return`${e} + ${n} = ${e+n}`;case"subtract":return`${e} - ${n} = ${e-n}`;case"multiply":return`${e} * ${n} = ${e*n}`;case"divide":if(n===0)throw new Error("Cannot divide by zero");return`${e} / ${n} = ${e/n}`;default:throw new Error(`Unknown operation: ${t}`)}},"execute")};class Vn{static{u(this,"ToolRegistry")}executables={};config;setConfig(e){this.config=e}register(e){if(this.executables[e.name])throw new Error(`Tool with name '${e.name}' is already registered`);this.executables[e.name]=e}get(e){const n=this.executables[e];if(!n)throw new Error(`Tool '${e}' is not registered`);return n.setConfig?.(this.config[e]),n}}let W;function Ce(){return W||(W=new Vn,W.register(Hn),W.register(Bn)),W}u(Ce,"getToolRegistry");const Zn={async convert(t,e){const{recorder:n,toolNames:s}=e,{message:o,system:r,replace:a}=t;let c;t.output?c=j.with(o,t.output):c=j.with(o),r&&(c.system=r);const l=[...new Set([...s??[],...t.tools??[]])];for(const i of l){const p=Ce().get(i);c.addTool(p)}if(a){for(const i of a)if(i.source==="file"){const p=U(i.files),d=await on(p,n);c.addInput(i.pattern,d)}}if(t.images)for(const i of t.images)try{const p=await H(i.file,"base64");c.addFile(p)}catch(p){throw new Error(`Failed to load image '${i.file}': ${p.message}`)}if(t.documents)for(const i of t.documents)try{const p=await H(i.file,"base64");c.addFile(p)}catch(p){throw new Error(`Failed to load document '${i.file}': ${p.message}`)}if(t.references)for(const i of t.references)try{const p=await H(i.file,"utf-8");c.addReference(p)}catch(p){throw new Error(`Failed to load reference file '${i.file}': ${p.message}`)}return c}};class zn{static{u(this,"StepToClassRegistry")}converters=new Map;get(e){const n=this.converters.get(e);if(!n)throw new Error(`No converter registered for step: ${e}`);return n}register(e,n){this.converters.set(e,n)}}class ne{static{u(this,"WriteOutputTask")}constructor(e,n=["response"]){this.output=e,this.keys=n}type="write-to-disk"}const Kn={async convert(t){if(t.keys){const e=U(t.keys);return new ne(t.output,e)}return new ne(t.output)}},se=new zn;se.register("write-to-disk",Kn),se.register("chat",Zn);async function z(t,e){const{recorder:n}=e,s=t.tools??void 0,o=t.steps.map(async r=>(r.uses,await se.get(r.uses).convert(r,{recorder:n,toolNames:s})));return Promise.all(o)}u(z,"configToTasks");async function Ae(t,e){const{batch:n}=t;return n.length===1?ve(n[0]):new Fn(n.map(s=>ve(s)))}u(Ae,"configToPlanner");function ve(t){switch(t.type){case"files":let e;return t["skip-if"]&&(e=t["skip-if"].map(s=>Xn(s))),new Dn(t.source,t.bind,e)}}u(ve,"batchOptionsToPlanner");function Xn(t){switch(t.type){case"file-exist":return new Un(t.pattern)}}u(Xn,"skipOptionsToSkipConditions");function Yn(t){return t.success===!1&&t.error!==void 0}u(Yn,"isErrorResult");function K(t,e){return{response:t,stats:e,success:!0}}u(K,"createResult");function X(t,e,n){return{response:e,stats:n,error:t,success:!1}}u(X,"createErrorResult");class Qn{static{u(this,"WriteToDiskTaskHandler")}taskType="write-to-disk";canHandle(e){return e&&typeof e=="object"&&"type"in e&&e.type==="write-to-disk"}async execute(e){const{task:n,variables:s,options:o={},recorder:r}=e,a=n.output,c=n.keys??[];if(o?.warnUnused){const p=c.filter(d=>!(d in s));p.length>0&&r?.warn?.log(`[Write To Disk] The following keys were not found in the variables: ${p.join(", ")}`)}let l="";if(c.length===1?l=s[c[0]]??"<not found>":l=c.map(p=>`[${p}]:
${s[p]??"<not found>"}
`).join(`
`),o?.dryRun){r?.info?.log("[Dry run] Write to Disk is not executed.");return}let i="";a.includes("*")?i=an(a,s.file):i=te(a,s,"{}"),await ln({filePath:i,content:l})}}var Y=(t=>(t.LastResult="lastResult",t))(Y||{});function es(t,e,n){const{options:s,recorder:o}=n,r=s?.warnUnused??!0;for(const[a,c]of Object.entries(t))r&&e[a]&&o?.warn?.log(`Warning: Variable "${a}" is being overwritten. Previous value: ${e[a]}, new value: ${c}`),e[a]=c}u(es,"setResultsIntoVariables");class ts{static{u(this,"ChatTaskHandler")}taskType="instruct";canHandle(e){return e&&typeof e=="object"&&"type"in e&&e.type==="instruct"}async execute(e){const{task:n,...s}=e;await ns({instruct:n,...s})}}async function ns(t){const{instruct:e,chat:n,provider:s,stats:o,variables:r,options:a,recorder:c}=t;e.system&&n.addSystem(e.system);const{message:l,instructions:i}=e.compile(r,{recorder:c,options:a});if(e.hasFiles()?n.addUser(l,i,e.files):n.addUser(l,i),e.hasTools()&&n.setTools(Object.values(e.tools)),a?.dryRun)return c?.debug?.log(n),{action:"complete"};let p=!0;for(;p;){const d=await Te({provider:s,messages:n.messages,tools:n.tools,recorder:c});if(o.in+=d.usage.in,o.out+=d.usage.out,d.type==="error")throw new Error(JSON.stringify(d.error));if(d.type==="success")switch(d.finishReason){case _.Stop:{if(d.content){const g=d.content;n.addAssistant({id:d.id,model:d.model,content:d.content,finishReason:d.finishReason});const m=M(g);n.addAssistant(m);const y=e.finalize(m,{recorder:c});es(y,r,{options:a,recorder:c}),r[Y.LastResult]=y}return p=!1,{action:"continue"}}case _.Length:throw new Error("Incomplete model output due to `max_tokens` parameter or token limit");case _.FunctionCall:{if(d.content&&n.addAssistant({id:d.id,model:d.model,content:d.content,finishReason:d.finishReason,toolCalls:d.toolCalls}),d.toolCalls&&d.toolCalls.length>0){const g=await ss(d.toolCalls,e,{recorder:c});c?.debug?.log(g),n.addTools(g),p=!0}else p=!1;break}}if(d.type!=="success")throw c?.debug?.log(d),new Error("Unexpected response type")}return{action:"continue"}}u(ns,"executeChatAction");async function ss(t,e,n={}){const{recorder:s}=n,o=[];for(const r of t)o.push(new Promise((a,c)=>{const l=e.tools[r.name];if(!l){c(`Tool not found: ${r.name}`);return}s?.debug?.heading.log(`Executing tool ${l.name}`);const i=r.parameters;l.execute(i).then(p=>{s?.debug?.log(`Complete tool ${l.name}: ${r.id}`),a({id:r.id,name:r.name,content:JSON.stringify(p)})}).catch(c)}));return Promise.all(o)}u(ss,"executeToolCalls");class rs{static{u(this,"TaskRegistry")}handlers=new Map;register(e){this.handlers.set(e.taskType,e)}getHandler(e){return this.handlers.get(e.type)}hasHandler(e){return this.handlers.has(e.type)}async executeTask(e){const{task:n}=e,s=n.type,o=this.getHandler(n);if(!o)throw new Error(`No handler registered for action type: ${s}`);if(!o.canHandle(n))throw new Error(`Handler found but action does not match expected format: ${s}`);await o.execute(e)}}function os(){const t=new rs;return t.register(new ts),t}u(os,"createBaseRegistry");function as(){const t=os();return t.register(new Qn),t}u(as,"createNodeRegistry");const re=u((t,...e)=>{const n=u(async o=>{const{recorder:r}=o;let a=[];return"steps"in t?a=await z(t,{recorder:r}):a=[t,...e],a},"prepare");return{execute:u(async o=>{const{provider:r,variables:a,options:c,stats:l,recorder:i,name:p}=o,d=crypto.randomUUID(),g=as();i?.info?.log({type:"task",id:d,status:w.Running,message:`[${$(d,p)}] Starting job`});try{const m=await n({recorder:i}),y=new Ye;for(const[T,I]of m.entries()){i?.info?.log({type:"task",id:d,status:w.Running,message:`[${$(d,p)}] Processing step ${T+1}: ${I.type}`});try{await g.executeTask({task:I,chat:y,provider:r,variables:a,options:c,stats:l,recorder:i})}catch(S){throw S instanceof k?S:new oe(`Error executing task ${I.type}`,{id:d,taskType:I.type,taskIndex:T,cause:S instanceof Error?S:new Error(String(S))})}}return i?.info?.log({type:"task",status:w.Success,id:d,message:`[${$(d,p)}] Completed ${m.length} steps`}),K(a[Y.LastResult],l)}catch(m){const y=m instanceof k?m:new k("Serial workflow execution failed",{id:d,cause:m instanceof Error?m:new Error(String(m))});return i?.info?.log({type:"task",status:w.Fail,id:d,message:`[${$(d,p)}] Failed: ${y.message}`}),i?.error.log(y),X(y,a[Y.LastResult],l)}},"execute")}},"serialWorkflow"),Me=u((t,...e)=>{const n=u(async o=>{const{recorder:r}=o;let a=[],c=null;if("batch"in t){const l=t;c=await Ae(l),a=await z(l,{recorder:r})}else c=t,a=[...e];return[c,a]},"prepare");return{execute:u(async o=>{const{provider:r,variables:a,options:c,stats:l,recorder:i,name:p}=o,d=crypto.randomUUID();try{const[g,m]=await n({recorder:i}),y=await g.plan(m);if(i?.debug?.heading.log("Runs",y),y.length===0)return i?.info?.log("No runs to execute"),K([],l);let T=0;i?.info?.log({type:"task",status:w.Running,id:d,message:`[${$(d,"CRW")}] Working on 0/${y.length}`});const I=u(async(R,G)=>{try{return await re(...R.tasks).execute({provider:r,variables:{...R.variables,...a},options:c,stats:l,recorder:i,name:`${p}-${G}`})}catch(C){const ae=C instanceof k?C:new k("Error executing run",{cause:C instanceof Error?C:new Error(String(C))});return i?.error?.log(ae),X(ae,null,l)}finally{T++,i?.info?.log({type:"task",status:w.Running,id:d,message:`[${$(d,"CRW")}] Working on ${T}/${y.length}`})}},"executeRun"),S=5;let v=[];for(let R=0;R<y.length;R+=S){const G=y.slice(R,R+S),C=await Promise.all(G.map(I));v=v.concat(C)}const P=v.some(Yn);i?.info?.log({type:"task",status:P?w.PartialSuccess:w.Success,id:d,message:`[${$(d,"CRW")}] All jobs (${y.length}) completed${P?" with some errors":""}`});const A=v.map(R=>R.response);return K(A,l)}catch(g){const m=g instanceof k?g:new k("Concurrent workflow execution failed",{id:d,cause:g instanceof Error?g:new Error(String(g))});return i?.error?.log(m),X(m,null,l)}},"execute")}},"concurrentWorkflow");class is{static{u(this,"DAGParser")}static parse(e){const n=new Map;for(const[o,r]of Object.entries(e)){const a=this.parseNodeDefinition(o,r);n.set(o,a)}return this.validateDependencies(n),this.checkForCycles(n),{stages:this.createExecutionStages(n),nodes:n}}static parseNodeDefinition(e,n){if(this.isSimpleTask(n))return{id:e,tasks:Array.isArray(n)?n:[n],dependencies:[],executionType:"serial"};if(this.isConcurrentNodeDefinition(n)){const a=n,c=a.dependsOn?U(a.dependsOn):[];return{id:e,tasks:a.tasks,dependencies:c,planner:a.planner,executionType:"concurrent"}}const s=n,o=s.dependsOn?U(s.dependsOn):[],r=U(s.task);return{id:e,tasks:r,dependencies:o,executionType:"serial"}}static isSimpleTask(e){return e.type||Array.isArray(e)}static isConcurrentNodeDefinition(e){return e&&typeof e=="object"&&"planner"in e}static validateDependencies(e){for(const n of e.values())for(const s of n.dependencies)if(!e.has(s))throw new k(`Node "${n.id}" depends on non-existent node "${s}"`)}static checkForCycles(e){const n=new Set,s=new Set,o=u(r=>{if(s.has(r))return!0;if(n.has(r))return!1;n.add(r),s.add(r);const a=e.get(r);for(const c of a.dependencies)if(o(c))return!0;return s.delete(r),!1},"hasCycle");for(const r of e.keys())if(o(r))throw new k(`Circular dependency detected involving node "${r}"`)}static createExecutionStages(e){const n=[],s=new Set,o=new Set(e.keys());for(;o.size>0;){const r=[];for(const a of o)e.get(a).dependencies.every(i=>s.has(i))&&r.push(a);if(r.length===0)throw new k("Unable to resolve DAG dependencies - possible circular reference");n.push(r),r.forEach(a=>{s.add(a),o.delete(a)})}return n}}class cs{static{u(this,"DAGJobToDefinition")}static async convert(e,n){const{recorder:s}=n,o={};for(const[r,a]of Object.entries(e)){const{dependsOn:c,...l}=a;if("batch"in l){const i=l,p=await Ae(i),d=await z(i,{recorder:s}),g={planner:p,tasks:d,...c?{dependsOn:c}:{}};o[r]=g}else{const i=await z(l,{recorder:s});if(c){const p={task:i,dependsOn:c};o[r]=p}else o[r]=i}}return o}}async function ls(t,e,n,s={}){const{variables:o}=n,r=e.nodes.get(t);try{let a;if(r.executionType==="concurrent"&&r.planner?a=await Me(r.planner,...r.tasks).execute({...n,variables:o,name:t}):a=await re(...r.tasks).execute({...n,variables:o,name:t}),!a.success)throw new k(`Node "${t}" failed: ${a.error?.message}`);return a.response}catch(a){if(!s.continueOnError)throw a;return null}}u(ls,"executeNode");const us=u((t,e={})=>{const n=u(async(o,r)=>{const{recorder:a}=r,c=Oe.safeParse(o);if(c.success)return await cs.convert(c.data,r);if(c.error){const l=c.error.issues.map(i=>`${i.path.join(".")}: ${i.message}`).join("; ");a?.warn?.log(`DAG validation warning: ${l}`)}return o},"prepare");return{execute:u(async o=>{const{stats:r,recorder:a}=o,{maxConcurrency:c=3}=e,l=crypto.randomUUID();try{const i=await n(t,{recorder:a});a?.debug?.log(i);const p=is.parse(i),d=new Map;a?.info?.log({type:"task",id:l,status:w.Running,message:`[${$(l)}] Starting workflow execution with ${p.stages.length} stages`});for(const[m,y]of p.stages.entries()){a?.info?.log({type:"task",id:l,status:w.Running,message:`[${$(l)}] Stage ${m+1}/${p.stages.length}, executing ${y.length} nodes: ${y.join(", ")}`});const T=Math.min(y.length,c);for(let I=0;I<y.length;I+=T){const S=y.slice(I,I+T);(await Promise.all(S.map(async P=>{const A=await ls(P,p,o,e);return{nodeId:P,result:A}}))).forEach(({nodeId:P,result:A})=>{d.set(P,A)})}}a?.info?.log({type:"task",status:w.Success,id:l,message:`[${$(l)}] Workflow execution completed successfully`});const g=Object.fromEntries(d);return K(g,r)}catch(i){const p=i instanceof k?i:new k("DAG workflow execution failed",{id:l,cause:i instanceof Error?i:new Error(String(i))});return a?.info?.log({type:"task",status:w.Fail,id:l,message:`[${$(l)}] Workflow execution failed: ${p.message}`}),a?.error?.log(p),X(p,null,r)}},"execute")}},"dagWorkflow"),ps=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"],N={success:"\u2713",fail:"\u2717",spinning:ps};class ds{static{u(this,"ConsoleWriter")}tasks=new Map;entries=[];truncate=0;intervalId=null;spinnerInterval=80;lastRender="";isRendering=!1;inline=!0;constructor(e={}){this.truncate=e.truncate??0,this.inline=e.inline??!0}startSpinner(){this.intervalId===null&&(this.intervalId=setInterval(()=>{[...this.tasks.values()].some(n=>n.status===w.Running)&&this.renderTasks()},this.spinnerInterval))}stopSpinner(){this.intervalId!==null&&(clearInterval(this.intervalId),this.intervalId=null)}renderTasks(){if(this.isRendering)return;if(this.isRendering=!0,this.inline&&this.lastRender){const r=this.lastRender.split(`
`).length;ue.moveCursor(process.stdout,0,-r+1),ue.clearScreenDown(process.stdout)}const e=[...this.tasks.values()],n=e.filter(r=>r.status===w.Running),s=e.filter(r=>r.status===w.Success||r.status===w.Fail);if(n.length===0&&s.length>0){let r="";for(const a of s){if(a.status===w.Success){const c=E.green(N.success);r+=`${c} ${a.text}
`}else if(a.status===w.Fail){const c=E.red(N.fail);r+=`${c} ${a.text}
`}this.tasks.delete(a.id)}console.log(r)}for(const r of this.entries){const{level:a,time:c,kind:l,payload:i}=r;l==="heading"?gs(a,i,{truncate:this.truncate}):ms(a,i,{truncate:this.truncate})}this.entries=[];let o="";for(const r of this.tasks.values())if(r.status===w.Running){const a=E.cyan(N.spinning[r.frameIndex]);r.frameIndex=(r.frameIndex+1)%N.spinning.length,o+=`${a} ${r.text}
`}else if(r.status===w.Success){const a=E.green(N.success);o+=`${a} ${r.text}
`}else if(r.status===w.Fail){const a=E.red(N.fail);o+=`${a} ${r.text}
`}this.lastRender=o,process.stdout.write(o),this.isRendering=!1}handleEvent(e){const{level:n,time:s,payload:o}=e;if(o.length>0&&fs(o[0])){const a=o[0],{id:c,message:l,status:i}=a;if(i===w.Running)this.tasks.set(c,{id:c,text:l,status:i,frameIndex:0});else if((i===w.Success||i===w.Fail)&&this.tasks.has(c)){const p=this.tasks.get(c);p.status=i,p.text=l}}else this.entries.push(e);this.renderTasks();const r=[...this.tasks.values()].some(a=>a.status===w.Running);r&&this.intervalId===null?this.startSpinner():!r&&this.intervalId!==null&&this.stopSpinner()}destroy(){this.stopSpinner()}}function fs(t){if(typeof t!="object"||t===null)return!1;const e=t;if(e.type!=="task"||typeof e.id!="string"||typeof e.message!="string")return!1;switch(e.status){case w.Running:case w.Success:case w.PartialSuccess:case w.Fail:return!0;default:return!1}}u(fs,"isTask");function gs(t,e,n){let s,o;t===b.Error?(s=E.red,o=E.redBright.bold):t===b.Warn?(s=E.yellow,o=E.yellowBright.bold):t>=b.Info?(s=E.blue,o=E.whiteBright.bold):(s=E.gray,o=E.white);const{message:r,data:a}=Ge(e);console.log(`${s("==>")} ${o(r)}`),Ne(t,a,n)}u(gs,"heading");function ms(t,e,n){let s;t===b.Error?s=E.red:t===b.Warn?s=E.yellow:t>=b.Info?s=E.white:s=E.gray;const{message:o,data:r}=Ge(e);o&&console.log(s(o)),Ne(t,r,n)}u(ms,"body");const je="    ";function Ne(t,e,n){let s;t===b.Error?(s=E.red,n.truncate=0):t==b.Warn?s=E.yellow:t>=b.Info?s=E.white:s=E.gray,e.forEach(o=>{if(typeof o=="string"){console.log(s(`${je}${o}`));return}for(const[r,a]of Object.entries(o)){let c=JSON.stringify(a,hs(n.truncate),"	");const l=`${r}: ${c}`.split(`
`).map(i=>je+i).join(`
`);console.log(s(l))}})}u(Ne,"values");function Ge(t){const[e,...n]=t;let s="",o=n;if(e){let{message:r,...a}=e;s=r&&typeof r=="string"?r:"",Object.keys(a).length>0&&(o=[a,...o])}return{message:s,data:o}}u(Ge,"toMsgData");function hs(t){return t===0?null:(e,n)=>typeof n=="string"&&n.length>t?n.slice(0,t)+"<...>":n}u(hs,"truncator");export{k as A,ds as C,j as I,b as L,sn as R,ne as W,Pe as a,V as b,Te as c,us as d,Me as e,rn as f,nn as g,Gn as h,$e as i,Cn as j,Ce as k,H as l,re as s};
